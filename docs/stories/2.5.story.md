# Story 2.5: Meeting Security and Access Controls

## Status
Draft

## MVP Scope

**‚úÖ INCLUDED IN MVP:**
1. Secure meeting URLs with expiration tokens
2. Role-based permissions (Host/Participant only - no co-host)
3. Waiting room enhancements (whitelist, participant info, auto-reject, time tracking)
4. Screen sharing permissions (simple toggle: allow all or host-only)
5. Chat message deletion (already in Story 2.4)

**üìã POST-LAUNCH (Deferred):**
1. Meeting passwords
2. Participant ban system
3. End meeting for all functionality
4. Audit logging system
5. Security dashboard
6. Meeting lock enhancements (basic lock from Story 2.3 is sufficient for MVP)
7. Co-host role and permissions

## Story

**As a** host,
**I want** secure meeting access controls and participant management,
**so that** my client meetings remain private and professional.

## Dependencies

**Required:**
- **Story 2.1** (Stream Infrastructure) - Meeting creation and access
- **Story 2.3** (Participant Management) - Waiting room and basic meeting lock
- **Story 2.4** (Chat) - Chat message deletion

## Acceptance Criteria (MVP Scope)

1. ~~Meeting passwords and secure room generation~~ **[POST-LAUNCH]**
2. **Waiting room enhancements:** whitelist, participant info display, auto-reject, time tracking
3. **Role-based permissions** (host, participant) - simplified from 3-role system
4. ~~Meeting lock functionality~~ **[ALREADY IMPLEMENTED in Story 2.3]**
5. ~~Participant removal with optional ban capability~~ **[POST-LAUNCH - basic removal already in 2.3]**
6. **Screen sharing permissions** - simple toggle (allow all vs host-only)
7. ~~Chat moderation tools and message deletion~~ **[ALREADY IMPLEMENTED in Story 2.4]**
8. ~~End meeting for all participants functionality~~ **[POST-LAUNCH]**
9. ~~Audit logging for security events and participant actions~~ **[POST-LAUNCH]**
10. **Encrypted meeting URLs with expiration times**

**MVP Acceptance Criteria Summary:**
- AC 2: Waiting room enhancements ‚úÖ
- AC 3: Role-based permissions (2 roles) ‚úÖ
- AC 6: Screen sharing toggle ‚úÖ
- AC 10: Secure URLs + expiration ‚úÖ

## Tasks / Subtasks

### üöÄ MVP TASKS

- [ ] **Database Migration** (AC: 2, 10)
  - [ ] Create migration 009_add_security_features.sql
  - [ ] Add invite_token (UUID) to meetings table
  - [ ] Add expires_at timestamp to meetings table
  - [ ] Add waiting_room_whitelist JSONB to meetings table
  - [ ] Add allow_participant_screenshare boolean to meetings table (default false)
  - [ ] Add indexes for security queries
  - [ ] Write migration tests

- [ ] **Secure Meeting URLs** (AC: 10)
  - [ ] Generate cryptographically secure invite links (crypto.randomUUID)
  - [ ] Add invite_token column (UUID v4) to meetings table
  - [ ] Implement link expiration with expires_at timestamp
  - [ ] Validate link expiration on join attempt
  - [ ] Allow host to regenerate invite link
  - [ ] Display "Link expired" error to users
  - [ ] Add link expiration setting UI (never, 24h, 7d, 30d)
  - [ ] Create API endpoint `/api/meetings/[id]/regenerate-link` (POST)
  - [ ] Write link validation tests

- [ ] **Role-Based Permissions - Simplified** (AC: 3, 6)
  - [ ] Define permission matrix for 2 roles (host, participant)
  - [ ] Remove co-host role from existing schema
  - [ ] Create permissions utility functions (isHost, canScreenShare, etc.)
  - [ ] Implement API authorization checks (host-only endpoints)
  - [ ] Update participants table role check to ('host', 'participant')
  - [ ] Write permission tests

- [ ] **Waiting Room Enhancements** (AC: 2)
  - [ ] Extend waiting room from Story 2.3 with enhancements
  - [ ] Add waiting_room_whitelist JSONB to meetings table
  - [ ] Implement "Always admit" whitelist UI (add/remove emails)
  - [ ] Check whitelist on join - auto-admit if email matches
  - [ ] Show participant email/name before admitting in WaitingRoomPanel
  - [ ] Add waiting time tracking (display time since joined_at)
  - [ ] Implement auto-reject after 10 minutes of waiting (cron or polling)
  - [ ] Create API endpoint `/api/meetings/[id]/whitelist` (GET/POST/DELETE)
  - [ ] Update WaitingRoomPanel to show email + waiting time
  - [ ] Write waiting room enhancement tests

- [ ] **Screen Sharing Permissions Toggle** (AC: 6)
  - [ ] Add allow_participant_screenshare boolean to meetings table
  - [ ] Create simple toggle in meeting settings: "Allow everyone to screen share"
  - [ ] Default to false (host-only)
  - [ ] When true: all participants can screen share
  - [ ] When false: only host can screen share
  - [ ] Create API endpoint `/api/meetings/[id]/screen-share-settings` (PUT)
  - [ ] Enforce permission checks before screen share (check isHost || allow_participant_screenshare)
  - [ ] Update meeting creation form to include this setting
  - [ ] Write screen sharing permission tests

- [ ] **Chat Message Deletion** (AC: 7)
  - [ ] Verify delete message functionality from Story 2.4
  - [ ] Ensure host can delete any message
  - [ ] Ensure participants can only delete own messages
  - [ ] No additional implementation needed (already in 2.4)

### üìã POST-LAUNCH TASKS (Deferred)

- [ ] **Meeting Password Feature** **[DEFERRED]**
  - Password generation, hashing, validation
  - Password UI components
  - Password change functionality

- [ ] **Meeting Lock Enhancement** **[DEFERRED]**
  - Prevent waiting room joins when locked
  - Show locked status on join page
  - Audit log lock events
  - *Note: Basic lock from Story 2.3 is sufficient for MVP*

- [ ] **Participant Ban Feature** **[DEFERRED]**
  - banned_participants table
  - Ban/unban API endpoints
  - Ban enforcement on rejoin

- [ ] **End Meeting for All** **[DEFERRED]**
  - End meeting button (host only)
  - Broadcast end event
  - Graceful disconnect all participants

- [ ] **Audit Logging System** **[DEFERRED]**
  - audit_logs table
  - Log security events (join, leave, remove, etc.)
  - Audit log API and UI

- [ ] **Security Dashboard** **[DEFERRED]**
  - SecurityPanel component
  - Display active security settings
  - Show audit log summary

## Dev Notes

### Dependencies Context

**Story 2.3 Provides (COMPLETE):**
- Waiting room infrastructure (WaitingRoomPanel, WaitingRoomView)
- Basic meeting lock functionality
- Participant removal API
- Role system (currently has host/co-host/participant)

**Story 2.4 Provides (COMPLETE):**
- Chat message deletion (host can delete any, participant can delete own)
- Chat permissions

**This story enhances** existing features with:
- Secure invite URLs with expiration
- Simplified role system (remove co-host)
- Waiting room whitelist and auto-reject
- Screen sharing toggle

### Technology Stack

[Source: architecture/tech-stack.md]

**Required Dependencies:**
- `crypto` (Node.js built-in) - Secure token generation

**Already Available:**
- `@tanstack/react-query` ^5.17.0
- `@supabase/supabase-js` ^2.38.0
- `zod` ^3.22.4

### Database Schema Updates

**Migration 009: Security Features (MVP Scope)**

```sql
-- Add secure tokens and expiration to meetings
ALTER TABLE meetings
ADD COLUMN invite_token UUID UNIQUE DEFAULT uuid_generate_v4(),
ADD COLUMN expires_at TIMESTAMP WITH TIME ZONE,
ADD COLUMN waiting_room_whitelist JSONB DEFAULT '[]'::jsonb,
ADD COLUMN allow_participant_screenshare BOOLEAN DEFAULT false;

-- Update participants role constraint (remove co-host for MVP)
ALTER TABLE participants
DROP CONSTRAINT IF EXISTS participants_role_check;

ALTER TABLE participants
ADD CONSTRAINT participants_role_check
CHECK (role IN ('host', 'participant'));

-- Add indexes for performance
CREATE INDEX idx_meetings_invite_token ON meetings(invite_token);
CREATE INDEX idx_meetings_expires_at ON meetings(expires_at);
```

### Permission Matrix (MVP - 2 Roles Only)

| Action | Host | Participant |
|--------|------|-------------|
| Start/End meeting | ‚úÖ | ‚ùå |
| Lock meeting | ‚úÖ | ‚ùå |
| Admit from waiting room | ‚úÖ | ‚ùå |
| Mute participants | ‚úÖ | ‚ùå |
| Remove participants | ‚úÖ | ‚ùå |
| Share screen | ‚úÖ | If allow_participant_screenshare enabled |
| Send chat messages | ‚úÖ | ‚úÖ |
| Delete any message | ‚úÖ | Own only |
| Regenerate invite link | ‚úÖ | ‚ùå |
| Manage whitelist | ‚úÖ | ‚ùå |

### API Endpoints (MVP Scope)

**Required Endpoints:**

1. **POST `/api/meetings/create`** (Enhanced)
   - Add invite_token and expires_at to response
   - Zod schema: Add optional `expiresIn: '24h' | '7d' | '30d' | 'never'`
   - Generate invite_token with crypto.randomUUID()
   - Calculate expires_at based on expiresIn
   - Returns: Meeting with invite URL

2. **POST `/api/meetings/[id]/regenerate-link`**
   - Generate new invite_token (host only)
   - Invalidate old link
   - Optionally update expiration
   - Zod schema: `{ expiresIn?: '24h' | '7d' | '30d' | 'never' }`
   - Returns: New invite URL

3. **GET `/api/meetings/join/[invite_token]`**
   - Validate invite_token exists
   - Check expires_at not passed
   - Check if user on whitelist (auto-admit)
   - Returns: Meeting join page or error

4. **GET `/api/meetings/[id]/whitelist`**
   - Get waiting room whitelist (host only)
   - Returns: Array of whitelisted emails

5. **POST `/api/meetings/[id]/whitelist`**
   - Add email to whitelist (host only)
   - Zod schema: `{ email: string }`
   - Returns: Updated whitelist

6. **DELETE `/api/meetings/[id]/whitelist/[email]`**
   - Remove email from whitelist (host only)
   - Returns: Updated whitelist

7. **PUT `/api/meetings/[id]/screen-share-settings`**
   - Update allow_participant_screenshare (host only)
   - Zod schema: `{ allowAll: boolean }`
   - Returns: Updated meeting

**Security:**
- All endpoints require Clerk JWT
- Host authorization checks
- Input sanitization via Zod
- Rate limiting: 100 req/min per user (defer to post-launch)

### Secure Link Generation

**Invite URL Format:**
```
https://meetsolis.com/meeting/join/550e8400-e29b-41d4-a716-446655440000
```

**Generation:**
```typescript
import crypto from 'crypto';

// Generate secure invite token
const inviteToken = crypto.randomUUID(); // UUID v4

// Calculate expiration
const expiresAt = expiresIn === 'never'
  ? null
  : new Date(Date.now() + parseExpiration(expiresIn));

// Store in database
await supabase.from('meetings').update({
  invite_token: inviteToken,
  expires_at: expiresAt
}).eq('id', meetingId);

// Return invite URL
const inviteUrl = `${process.env.NEXT_PUBLIC_APP_URL}/meeting/join/${inviteToken}`;
```

**Validation:**
```typescript
// Check if link expired
if (meeting.expires_at && new Date(meeting.expires_at) < new Date()) {
  return { error: 'Meeting link has expired' };
}
```

### Waiting Room Enhancements

**Whitelist Implementation:**

```typescript
// Check if user is whitelisted
const whitelist = meeting.waiting_room_whitelist || [];
const userEmail = user.emailAddresses[0]?.emailAddress;

if (whitelist.includes(userEmail)) {
  // Auto-admit - skip waiting room
  await admitToMeeting(meetingId, userId);
} else {
  // Send to waiting room
  await addToWaitingRoom(meetingId, userId);
}
```

**Waiting Time Display:**

```typescript
// In WaitingRoomPanel component
const waitingTime = Math.floor((Date.now() - new Date(participant.joined_at).getTime()) / 1000);
const minutes = Math.floor(waitingTime / 60);
const seconds = waitingTime % 60;

// Display: "‚è±Ô∏è Waiting 2m 35s"
```

**Auto-Reject After 10 Minutes:**

```typescript
// In waiting room polling (or cron job)
const tenMinutesAgo = new Date(Date.now() - 10 * 60 * 1000);

const expiredParticipants = await supabase
  .from('waiting_room_participants')
  .select('*')
  .eq('meeting_id', meetingId)
  .eq('status', 'waiting')
  .lt('joined_at', tenMinutesAgo.toISOString());

// Auto-reject expired participants
for (const participant of expiredParticipants.data) {
  await rejectFromWaitingRoom(meetingId, participant.user_id);
}
```

**Enhanced WaitingRoomPanel UI:**

```tsx
// Show participant info before admitting
<div className="waiting-participant">
  <Avatar>{participant.display_name[0]}</Avatar>
  <div>
    <p className="font-medium">{participant.display_name}</p>
    <p className="text-sm text-muted">{participant.email}</p>
    <p className="text-xs text-muted">‚è±Ô∏è Waiting {formatWaitTime(participant.joined_at)}</p>
  </div>
  <Button onClick={() => admit(participant.user_id)}>Admit</Button>
  <Button onClick={() => reject(participant.user_id)}>Reject</Button>
</div>
```

### Screen Sharing Toggle Implementation

**Simple Toggle Approach (User Preference):**

```typescript
// In meeting settings
const [allowAllScreenShare, setAllowAllScreenShare] = useState(false);

// Toggle UI
<Switch
  checked={allowAllScreenShare}
  onCheckedChange={(checked) => {
    updateScreenShareSettings(meetingId, { allowAll: checked });
  }}
  label="Allow everyone to screen share"
/>

// Permission check before screen share
const canScreenShare = isHost || meeting.allow_participant_screenshare;

if (!canScreenShare) {
  toast.error('Only the host can screen share');
  return;
}

// Proceed with screen share
await call.startScreenShare();
```

**No request/approval workflow needed** - simple boolean toggle.

### Accessibility Requirements

[Source: architecture/frontend-architecture.md]

**WCAG 2.1 AA Compliance:**
- Whitelist management UI keyboard accessible
- ARIA labels for all security controls
- Screen reader announcements for waiting room events
- Focus management in dialogs
- Clear error messages for expired links

### Performance Considerations

- **Link Validation:** Index on invite_token for fast lookups
- **Whitelist Checks:** JSONB array lookup is fast (<10ms)
- **Waiting Time Calculation:** Client-side computation, no DB overhead
- **Auto-Reject:** Cron job or polling every 60s (low overhead)

### Testing Strategy

**Test File Locations:**
- Component tests: `src/components/meeting/__tests__/`
- API tests: `src/app/api/meetings/__tests__/`
- E2E tests: `tests/e2e/security/`

**Key Test Scenarios:**
1. Create meeting with expiration link
2. Join with valid invite_token
3. Join with expired invite_token (expect error)
4. Whitelist user - auto-admit flow
5. Non-whitelisted user - waiting room flow
6. Waiting time display updates correctly
7. Auto-reject after 10 minutes
8. Host toggles screen share permission
9. Participant tries to screen share (with/without permission)
10. Host regenerates invite link (old link invalid)

**Success Criteria:**
- All MVP features functional
- Invite links secure and validate expiration
- Waiting room enhancements work correctly
- Screen sharing toggle enforced properly
- Performance meets requirements
- Accessibility tests pass

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-13 | 1.0 | Initial story creation for meeting security and access controls | Bob (Scrum Master) |
| 2025-12-21 | 2.0 | **MVP SCOPE REVISION** - Simplified to secure URLs, 2-role permissions, waiting room enhancements, screen share toggle. Deferred: passwords, bans, audit logging, end-for-all, co-host role. | Sarah (Product Owner) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

## QA Results

*Results from QA Agent review will be populated here after story completion*
