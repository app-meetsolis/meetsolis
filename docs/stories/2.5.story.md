# Story 2.5: Meeting Security and Access Controls

## Status
Draft

## Story

**As a** host,
**I want** robust security controls to protect my client meetings,
**so that** sensitive business discussions remain private and professional.

## Dependencies

**Required:**
- **Story 2.1** (WebRTC Infrastructure) - Meeting creation and access
- **Story 2.3** (Participant Management) - Waiting room and participant controls
- **Story 2.4** (Chat) - Chat moderation tools

## Acceptance Criteria

1. Meeting passwords and secure room generation
2. Waiting room with host approval for new participants
3. Role-based permissions (host, co-host, participant)
4. Meeting lock functionality to prevent uninvited access
5. Participant removal with optional ban capability
6. Screen sharing permissions (host-only by default)
7. Chat moderation tools and message deletion
8. End meeting for all participants functionality
9. Audit logging for security events and participant actions
10. Encrypted meeting URLs with expiration times

## Tasks / Subtasks

- [ ] **Meeting Password Feature** (AC: 1, 10)
  - [ ] Add password field to meeting creation form
  - [ ] Generate secure meeting passwords using crypto.randomBytes
  - [ ] Hash passwords using bcrypt before storing
  - [ ] Add password_hash column to meetings table (migration 009)
  - [ ] Validate password on meeting join
  - [ ] Create password input UI for participants
  - [ ] Add "Show/Hide password" toggle
  - [ ] Implement password change functionality (host only)
  - [ ] Write password validation tests

- [ ] **Secure Meeting URLs** (AC: 1, 10)
  - [ ] Generate cryptographically secure invite links
  - [ ] Add invite_token column (UUID v4) to meetings table
  - [ ] Implement link expiration with expires_at timestamp
  - [ ] Validate link expiration on join attempt
  - [ ] Allow host to regenerate invite link
  - [ ] Display "Link expired" error to users
  - [ ] Add link expiration setting (never, 24h, 7d, 30d)
  - [ ] Write link validation tests

- [ ] **Role-Based Permissions** (AC: 3, 6)
  - [ ] Define permission matrix for roles (host, co-host, participant)
  - [ ] Create permissions utility functions
  - [ ] Implement API authorization checks
  - [ ] Add permissions JSONB to participants table (already exists)
  - [ ] Create permission override UI for hosts
  - [ ] Restrict screen sharing by default (host-only)
  - [ ] Enforce permissions in WebRTC signaling
  - [ ] Write permission tests

- [ ] **Waiting Room Security** (AC: 2)
  - [ ] Enhance waiting room from Story 2.3
  - [ ] Add waiting room bypass for co-hosts
  - [ ] Implement "Always admit" whitelist
  - [ ] Show participant email/info before admitting
  - [ ] Add waiting time tracking
  - [ ] Auto-reject after 10 minutes of waiting
  - [ ] Write waiting room security tests

- [ ] **Meeting Lock Enhancement** (AC: 4)
  - [ ] Extend lock feature from Story 2.3
  - [ ] Prevent waiting room joins when locked
  - [ ] Show locked status on join page
  - [ ] Add "Meeting is locked" error message
  - [ ] Allow co-hosts to lock/unlock
  - [ ] Audit log lock/unlock events
  - [ ] Write lock tests

- [ ] **Participant Ban Feature** (AC: 5)
  - [ ] Create banned_participants table (migration 009)
  - [ ] Add "Ban participant" option in removal dialog
  - [ ] Store banned user_id with meeting_id
  - [ ] Prevent banned users from rejoining
  - [ ] Show "You have been banned" message
  - [ ] Create API endpoint `/api/meetings/[id]/bans` (POST/GET/DELETE)
  - [ ] Add unban functionality for host
  - [ ] Write ban/unban tests

- [ ] **Screen Sharing Permissions** (AC: 6)
  - [ ] Add can_share_screen to participant permissions
  - [ ] Create screen sharing request workflow
  - [ ] Implement host approval for screen sharing requests
  - [ ] Add screen sharing permission toggle in settings
  - [ ] Create API endpoint `/api/meetings/[id]/participants/[userId]/permissions` (PUT)
  - [ ] Enforce permission checks before screen share
  - [ ] Write permission tests

- [ ] **Chat Moderation** (AC: 7)
  - [ ] Extend chat from Story 2.4 with moderation
  - [ ] Add "Delete message" for host (already in Story 2.4)
  - [ ] Add "Delete all messages from user" functionality
  - [ ] Implement temporary chat mute for participants
  - [ ] Create moderation log in database
  - [ ] Show moderation actions to other hosts
  - [ ] Write moderation tests

- [ ] **End Meeting for All** (AC: 8)
  - [ ] Add "End meeting for all" button (host only)
  - [ ] Create confirmation dialog with warning
  - [ ] Create API endpoint `/api/meetings/[id]/end` (POST)
  - [ ] Update meeting status to 'ended'
  - [ ] Broadcast end event via Supabase Realtime
  - [ ] Disconnect all participants gracefully
  - [ ] Show "Meeting ended by host" message
  - [ ] Write end meeting tests

- [ ] **Audit Logging** (AC: 9)
  - [ ] Create audit_logs table (migration 009)
  - [ ] Log security events (join, leave, mute, remove, ban)
  - [ ] Log permission changes
  - [ ] Log meeting lock/unlock events
  - [ ] Create API endpoint `/api/meetings/[id]/audit-log` (GET)
  - [ ] Display audit log in admin panel
  - [ ] Implement log retention policy (90 days)
  - [ ] Write audit log tests

- [ ] **Security Dashboard** (AC: 9)
  - [ ] Create SecurityPanel component
  - [ ] Display active security settings
  - [ ] Show audit log summary
  - [ ] Display banned participants list
  - [ ] Add security event notifications
  - [ ] Show connection attempt history
  - [ ] Write component tests

- [ ] **Database Migrations** (AC: 1, 5, 9)
  - [ ] Create migration 009_add_security_features.sql
  - [ ] Add password_hash to meetings table
  - [ ] Add invite_token and expires_at to meetings table
  - [ ] Create banned_participants table
  - [ ] Create audit_logs table
  - [ ] Create moderation_log table
  - [ ] Add indexes for security queries
  - [ ] Write migration tests

## Dev Notes

### Dependencies Context

**Story 2.3 Provides:**
- Waiting room infrastructure
- Meeting lock functionality
- Participant removal API

**Story 2.4 Provides:**
- Chat message deletion
- Chat permissions

**This story enhances** existing features with additional security layers and adds new security features like passwords, bans, and audit logging.

### Previous Story Insights

From **Story 2.4** (Chat):
- Real-time synchronization patterns
- Permission-based feature access
- Message moderation patterns

From **Story 2.3** (Participant Management):
- Waiting room implementation
- Host control patterns
- Role-based actions

From **Story 1.9** (Security):
- Input validation with Zod
- Rate limiting patterns
- CSRF protection
- Audit logging best practices

### Technology Stack

[Source: architecture/tech-stack.md]

**Required Dependencies:**
- `bcrypt` ^5.1.1 - Password hashing
- `crypto` (Node.js built-in) - Secure token generation
- `@supabase/supabase-js` ^2.38.0 - Database and RLS

**Already Available:**
- `@tanstack/react-query` ^5.17.0
- `@supabase/realtime-js` ^2.9.3
- `zod` ^3.22.4

### Database Schema Updates

**Migration 009: Security Features**

```sql
-- Add password and secure tokens to meetings
ALTER TABLE meetings
ADD COLUMN password_hash TEXT,
ADD COLUMN invite_token UUID UNIQUE DEFAULT uuid_generate_v4(),
ADD COLUMN expires_at TIMESTAMP WITH TIME ZONE;

-- Create banned participants table
CREATE TABLE banned_participants (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    meeting_id UUID NOT NULL REFERENCES meetings(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    banned_by UUID NOT NULL REFERENCES users(id),
    reason TEXT,
    banned_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(meeting_id, user_id)
);

CREATE INDEX idx_banned_participants_meeting_id ON banned_participants(meeting_id);
CREATE INDEX idx_banned_participants_user_id ON banned_participants(user_id);

-- Create audit logs table
CREATE TABLE audit_logs (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    meeting_id UUID NOT NULL REFERENCES meetings(id) ON DELETE CASCADE,
    actor_id UUID NOT NULL REFERENCES users(id),
    action TEXT NOT NULL, -- 'join', 'leave', 'mute', 'remove', 'ban', 'lock', etc.
    target_id UUID REFERENCES users(id),
    details JSONB,
    ip_address INET,
    user_agent TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_audit_logs_meeting_id ON audit_logs(meeting_id);
CREATE INDEX idx_audit_logs_actor_id ON audit_logs(actor_id);
CREATE INDEX idx_audit_logs_created_at ON audit_logs(created_at);
CREATE INDEX idx_audit_logs_action ON audit_logs(action);

-- Create moderation log table
CREATE TABLE moderation_log (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    meeting_id UUID NOT NULL REFERENCES meetings(id) ON DELETE CASCADE,
    moderator_id UUID NOT NULL REFERENCES users(id),
    action TEXT NOT NULL, -- 'delete_message', 'mute_chat', 'ban_user'
    target_id UUID REFERENCES users(id),
    message_id UUID REFERENCES messages(id),
    reason TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_moderation_log_meeting_id ON moderation_log(meeting_id);
```

### Permission Matrix

[Source: architecture/database-schema.md + business logic]

| Action | Host | Co-Host | Participant |
|--------|------|---------|-------------|
| Start/End meeting | ✅ | ❌ | ❌ |
| Lock meeting | ✅ | ✅ | ❌ |
| Admit from waiting room | ✅ | ✅ | ❌ |
| Mute participants | ✅ | ✅ | ❌ |
| Remove participants | ✅ | ✅ | ❌ |
| Ban participants | ✅ | ❌ | ❌ |
| Change permissions | ✅ | ❌ | ❌ |
| Share screen | ✅ | By permission | By permission |
| Send chat messages | ✅ | ✅ | If enabled |
| Delete any message | ✅ | ✅ | Own only |
| View audit log | ✅ | ❌ | ❌ |

### API Endpoints

**Required Endpoints:**

1. **POST `/api/meetings/create`** (Enhanced)
   - Add password and expiration to Zod schema
   - Hash password with bcrypt (10 rounds)
   - Generate secure invite_token
   - Returns: Meeting with invite link

2. **POST `/api/meetings/[id]/validate-password`**
   - Validate meeting password
   - Zod schema: `{ password: string }`
   - Rate limit: 5 attempts per 5 minutes
   - Returns: Success/failure

3. **POST `/api/meetings/[id]/regenerate-link`**
   - Generate new invite_token (host only)
   - Invalidate old link
   - Returns: New invite URL

4. **POST `/api/meetings/[id]/bans`**
   - Ban participant (host only)
   - Zod schema: `{ user_id: string, reason?: string }`
   - Returns: Ban record

5. **DELETE `/api/meetings/[id]/bans/[userId]`**
   - Unban participant (host only)
   - Returns: Success

6. **POST `/api/meetings/[id]/end`**
   - End meeting for all (host only)
   - Updates meeting status to 'ended'
   - Broadcasts end event
   - Returns: Success

7. **GET `/api/meetings/[id]/audit-log`**
   - Get audit log (host only)
   - Query params: `?limit=100&offset=0&action=join`
   - Returns: Array of audit events

8. **PUT `/api/meetings/[id]/participants/[userId]/permissions`**
   - Update participant permissions (host only)
   - Zod schema: `{ permissions: PermissionsObject }`
   - Returns: Updated participant

**Security:**
- All endpoints require Clerk JWT
- Host/co-host authorization checks
- Rate limiting on password attempts
- Audit log all security actions
- IP address logging for security events

### Password Security

**Hashing:**
```typescript
import bcrypt from 'bcrypt';

// Hash password
const saltRounds = 10;
const passwordHash = await bcrypt.hash(password, saltRounds);

// Validate password
const isValid = await bcrypt.compare(inputPassword, passwordHash);
```

**Secure Link Generation:**
```typescript
import crypto from 'crypto';

// Generate secure invite token
const inviteToken = crypto.randomUUID(); // UUID v4

// Generate meeting URL
const inviteUrl = `https://meetsolis.com/meeting/${inviteToken}`;
```

### Audit Logging Implementation

**Log Function:**
```typescript
async function logAuditEvent(params: {
  meeting_id: string;
  actor_id: string;
  action: string;
  target_id?: string;
  details?: Record<string, any>;
  req: NextRequest;
}) {
  const { meeting_id, actor_id, action, target_id, details, req } = params;

  const ip_address = req.headers.get('x-forwarded-for') || req.headers.get('x-real-ip');
  const user_agent = req.headers.get('user-agent');

  await supabase.from('audit_logs').insert({
    meeting_id,
    actor_id,
    action,
    target_id,
    details,
    ip_address,
    user_agent
  });
}

// Usage
await logAuditEvent({
  meeting_id: meetingId,
  actor_id: hostId,
  action: 'ban_participant',
  target_id: participantId,
  details: { reason: 'Disruptive behavior' },
  req
});
```

**Audit Actions:**
- `join` - Participant joined
- `leave` - Participant left
- `remove` - Participant removed
- `ban` - Participant banned
- `unban` - Participant unbanned
- `mute` - Participant muted
- `lock` - Meeting locked
- `unlock` - Meeting unlocked
- `end` - Meeting ended
- `permission_change` - Permissions updated

### Real-Time Security Events

```typescript
// Broadcast meeting end
supabase
  .channel(`meeting:${meetingId}`)
  .send({
    type: 'broadcast',
    event: 'meeting_ended',
    payload: {
      ended_by: hostId,
      reason: 'Host ended meeting'
    }
  });

// Listen for meeting end
channel.on('broadcast', { event: 'meeting_ended' }, (payload) => {
  // Show "Meeting ended" modal
  // Disconnect WebRTC
  // Redirect to dashboard
});
```

### Accessibility Requirements

[Source: architecture/frontend-architecture.md]

**WCAG 2.1 AA Compliance:**
- Security dialogs keyboard accessible
- ARIA labels for all security controls
- Screen reader announcements for security events
- Focus management in confirmation dialogs
- Clear error messages for validation failures

### Performance Considerations

- **Password Hashing:** Use bcrypt async to avoid blocking
- **Audit Logging:** Use background jobs for non-critical logs
- **Ban Checks:** Cache banned user list (5 min TTL)
- **Link Validation:** Index on invite_token for fast lookups

### Testing Strategy

**Test File Locations:**
- Component tests: `src/components/meeting/__tests__/`
- API tests: `src/app/api/meetings/__tests__/`
- E2E tests: `tests/e2e/security/`

**Key Test Scenarios:**
1. Create meeting with password
2. Validate correct/incorrect password
3. Join with expired invite link
4. Ban participant and verify cannot rejoin
5. End meeting for all participants
6. Audit log records all actions
7. Role permissions enforced correctly
8. Screen sharing permission workflow
9. Regenerate invite link invalidates old link
10. Waiting room security checks

**Success Criteria:**
- All security features functional
- Audit log complete and accurate
- No unauthorized access possible
- Performance meets requirements
- Accessibility tests pass

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-13 | 1.0 | Initial story creation for meeting security and access controls | Bob (Scrum Master) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

## QA Results

*Results from QA Agent review will be populated here after story completion*
