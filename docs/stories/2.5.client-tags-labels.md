# Story 2.5: Client Tags & Labels

## Status

Draft

---

## Story

**As a** user,
**I want** to add tags to clients (e.g., VIP, Active, On Hold),
**so that** I can categorize and filter clients.

---

## Acceptance Criteria

1. Tags stored as JSONB array in clients table
2. Add tag input on client edit form
3. Tag autocomplete (suggest existing tags)
4. Tag pills displayed on client card
5. Free tier: Max 3 tags per client
6. Pro tier: Unlimited tags
7. Predefined tags: "VIP", "High Priority", "On Hold", "Active", "Inactive"
8. Custom tags allowed
9. Click tag on client card → Filter by that tag
10. Tag colors: Auto-assigned from palette

---

## Tasks / Subtasks

- [ ] **Task 1: Tag Input Component** (AC: 2, 3, 5, 6, 7, 8)
  - [ ] Create `apps/web/src/components/clients/TagInput.tsx`
  - [ ] Implement tag input with autocomplete (Shadcn Combobox or react-tag-input)
  - [ ] Show predefined tags: ["VIP", "High Priority", "On Hold", "Active", "Inactive"]
  - [ ] Allow custom tag entry (user can type new tag)
  - [ ] Validate max tags: Free tier (3), Pro tier (unlimited/50)
  - [ ] Display current tags as pills with remove (X) button
  - [ ] Autocomplete suggests existing tags from user's clients

- [ ] **Task 2: Tag Pills Component** (AC: 4, 9, 10)
  - [ ] Create `apps/web/src/components/clients/TagPill.tsx`
  - [ ] Props: `tag` string, `onClick` callback, `removable` boolean
  - [ ] Pill styling: Rounded (border-radius: 12px), small text (11px)
  - [ ] Auto-assign colors from palette based on tag name (hash function)
  - [ ] Make clickable → trigger filter by tag (if onClick provided)
  - [ ] Add remove (X) icon if removable=true

- [ ] **Task 3: Tag Color Palette** (AC: 10)
  - [ ] Define color palette (8-10 colors):
    - Blue: #DBEAFE
    - Green: #D1FAE5
    - Yellow: #FEF3C7
    - Red: #FEE2E2
    - Purple: #EDE9FE
    - Pink: #FCE7F3
    - Orange: #FFEDD5
    - Gray: #F3F4F6
  - [ ] Create hash function: `getTagColor(tag: string) => color`
  - [ ] Hash tag string to index in color palette
  - [ ] Ensure same tag always gets same color

- [ ] **Task 4: Update Client Form** (AC: 2)
  - [ ] Add TagInput component to ClientForm (Story 2.3)
  - [ ] Add tags field to form schema (array of strings)
  - [ ] Save tags when creating/updating client
  - [ ] Validate max tags based on user tier

- [ ] **Task 5: Display Tags on Client Card** (AC: 4)
  - [ ] Update ClientCard component (Story 2.2)
  - [ ] Display tags as TagPill components
  - [ ] Limit visible tags: Show first 3, "+ X more" if more than 3
  - [ ] Make tags clickable → filter by tag

- [ ] **Task 6: Tag Filtering Integration** (AC: 9)
  - [ ] Update ClientSearch component (Story 2.4)
  - [ ] Add tag filter UI (show all unique tags from user's clients)
  - [ ] Allow multi-select tag filtering
  - [ ] Update URL query params: `/clients?tags=vip,active`
  - [ ] Clicking tag pill on card → add to filter + update URL

- [ ] **Task 7: Tier Limit Enforcement** (AC: 5, 6)
  - [ ] Check user tier when adding tags
  - [ ] Free tier: Max 3 tags per client
  - [ ] Pro tier: Max 50 tags per client (effectively unlimited)
  - [ ] Show error message if limit exceeded: "Free tier limited to 3 tags. Upgrade to Pro for unlimited tags."
  - [ ] Prevent adding more tags when limit reached

- [ ] **Task 8: Autocomplete Logic** (AC: 3)
  - [ ] Fetch all unique tags from user's clients
  - [ ] Combine predefined tags + user's existing tags
  - [ ] Filter suggestions based on input (case-insensitive)
  - [ ] Show suggestions in dropdown below input
  - [ ] Select tag on click or Enter key

- [ ] **Task 9: Component Tests**
  - [ ] Test TagInput: add tag, remove tag, autocomplete
  - [ ] Test TagPill: display, click, color assignment
  - [ ] Test tier limit enforcement (free tier max 3)
  - [ ] Test tag filtering (click tag → filter)
  - [ ] Test tag display on client card
  - [ ] Test autocomplete with predefined + custom tags

---

## Dev Notes

### Relevant Architecture

**Database Schema:**
```sql
-- Tags stored as JSONB array in clients table
tags TEXT[] DEFAULT '{}',

-- Example:
tags: ["VIP", "Active", "High Priority"]
```

**Tag Color Hash Function:**
```typescript
const TAG_COLORS = [
  '#DBEAFE', // Blue
  '#D1FAE5', // Green
  '#FEF3C7', // Yellow
  '#FEE2E2', // Red
  '#EDE9FE', // Purple
  '#FCE7F3', // Pink
  '#FFEDD5', // Orange
  '#F3F4F6', // Gray
];

function getTagColor(tag: string): string {
  let hash = 0;
  for (let i = 0; i < tag.length; i++) {
    hash = tag.charCodeAt(i) + ((hash << 5) - hash);
  }
  return TAG_COLORS[Math.abs(hash) % TAG_COLORS.length];
}
```

**Predefined Tags:**
```typescript
const PREDEFINED_TAGS = [
  'VIP',
  'High Priority',
  'On Hold',
  'Active',
  'Inactive',
];
```

**Component Library:**
- Shadcn Combobox for autocomplete
- Shadcn Badge for tag pills
- Lucide icons: X (remove tag)

**Tier Limits:**
```typescript
const MAX_TAGS_FREE = 3;
const MAX_TAGS_PRO = 50;

const maxTags = userPrefs.tier === 'free' ? MAX_TAGS_FREE : MAX_TAGS_PRO;
```

**Source Tree:**
- Tag input: `apps/web/src/components/clients/TagInput.tsx`
- Tag pill: `apps/web/src/components/clients/TagPill.tsx`
- Integration: Update `ClientForm.tsx`, `ClientCard.tsx`, `ClientSearch.tsx`

**Autocomplete Data:**
```typescript
// Fetch all unique tags from user's clients
const allTags = useMemo(() => {
  const tags = new Set<string>(PREDEFINED_TAGS);
  clients?.forEach(client => {
    client.tags.forEach(tag => tags.add(tag));
  });
  return Array.from(tags);
}, [clients]);
```

### Testing

**Test Location:**
- Component tests: `apps/web/src/components/clients/__tests__/`

**Testing Standards:**
- Use Jest + Testing Library
- Mock user tier (free/pro) for tier limit tests
- Test tag color consistency (same tag = same color)

**Specific Requirements:**
- Test tag input autocomplete
- Test tag pill color assignment
- Test tier limit enforcement
- Test tag filtering (click tag → filter clients)
- Test tag display on client card
- Test tag removal

**Example Test Pattern:**
```typescript
import { render, screen, fireEvent } from '@testing-library/react';
import TagInput from '../TagInput';

test('enforces free tier limit of 3 tags', () => {
  const userPrefs = { tier: 'free', max_tags: 3 };
  render(<TagInput tags={['VIP', 'Active', 'High Priority']} userPrefs={userPrefs} />);

  // Try to add 4th tag
  fireEvent.change(screen.getByRole('textbox'), { target: { value: 'New Tag' } });
  fireEvent.submit(screen.getByRole('textbox'));

  // Should show error
  expect(screen.getByText(/limited to 3 tags/i)).toBeInTheDocument();
});
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-07 | 1.0 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

---

## QA Results

*This section will be populated by the QA agent after story completion.*
