# Story 2.3: Add/Edit Client Modal

## Status

Draft

---

## Story

**As a** user,
**I want** to add new clients and edit existing ones via a simple form,
**so that** I can maintain accurate client information.

---

## Acceptance Criteria

1. "+ Add Client" button opens modal with form
2. Form fields: Name*, Company, Role, Email, Phone, Website, LinkedIn URL (* = required)
3. Real-time validation (Zod)
4. Error messages inline (e.g., "Invalid email format")
5. "Save" button disabled until form valid
6. Cancel button closes modal (confirm if changes made)
7. Edit mode: Pre-fill form with existing data
8. Success toast: "Client added successfully"
9. Auto-close modal on save
10. Free tier warning: "You've reached your client limit (3/3). Upgrade to Pro for 50 clients."

---

## Tasks / Subtasks

- [ ] **Task 1: Client Modal Component** (AC: 1, 6, 9)
  - [ ] Create `apps/web/src/components/clients/ClientModal.tsx`
  - [ ] Props: `isOpen`, `onClose`, `mode` ('create' | 'edit'), `client?` (for edit mode)
  - [ ] Use Shadcn Dialog component for modal
  - [ ] Add modal header: "Add Client" or "Edit Client"
  - [ ] Add Cancel and Save buttons in modal footer
  - [ ] Implement onClose with confirmation if form has unsaved changes
  - [ ] Auto-close modal on successful save

- [ ] **Task 2: Client Form Component** (AC: 2, 3, 4, 5)
  - [ ] Create `apps/web/src/components/clients/ClientForm.tsx`
  - [ ] Use react-hook-form for form state management
  - [ ] Integrate Zod validation schema (from Story 2.1)
  - [ ] Form fields:
    - Name (required): Text input
    - Company (optional): Text input
    - Role (optional): Text input
    - Email (optional): Email input with validation
    - Phone (optional): Tel input
    - Website (optional): URL input with validation
    - LinkedIn URL (optional): URL input with validation
  - [ ] Display validation errors inline below each field
  - [ ] Disable Save button when form is invalid (`!isValid`)
  - [ ] Enable Save button when form is valid

- [ ] **Task 3: Form Validation** (AC: 3, 4)
  - [ ] Implement real-time validation with Zod
  - [ ] Name: Required, 2-100 characters
  - [ ] Email: Valid email format (if provided)
  - [ ] Website: Valid URL format (if provided)
  - [ ] LinkedIn URL: Valid URL format (if provided)
  - [ ] Phone: No specific format validation (allow any string)
  - [ ] Display error messages:
    - "Name is required"
    - "Name must be at least 2 characters"
    - "Invalid email format"
    - "Invalid URL format"

- [ ] **Task 4: Create Client Flow** (AC: 1, 8, 9)
  - [ ] Implement onSubmit handler for create mode
  - [ ] Call POST /api/clients with form data
  - [ ] Handle success: Show toast "Client added successfully"
  - [ ] Handle success: Invalidate react-query cache for ['clients']
  - [ ] Handle success: Close modal
  - [ ] Handle error: Display error message (API errors)

- [ ] **Task 5: Edit Client Flow** (AC: 7, 8, 9)
  - [ ] Pre-fill form with client data in edit mode
  - [ ] Implement onSubmit handler for edit mode
  - [ ] Call PUT /api/clients/[id] with form data
  - [ ] Handle success: Show toast "Client updated successfully"
  - [ ] Handle success: Invalidate react-query cache
  - [ ] Handle success: Close modal
  - [ ] Handle error: Display error message

- [ ] **Task 6: Tier Limit Handling** (AC: 10)
  - [ ] Check tier limit before opening modal (create mode)
  - [ ] If limit reached (free tier 3/3), show warning instead:
    - Title: "Client Limit Reached"
    - Message: "You've reached your client limit (3/3). Upgrade to Pro for 50 clients."
    - Buttons: "Upgrade" (link to /pricing), "Cancel"
  - [ ] Prevent modal from opening if tier limit reached
  - [ ] Allow edit mode even if tier limit reached

- [ ] **Task 7: Toast Notifications** (AC: 8)
  - [ ] Install and configure toast library (Shadcn Toast or react-hot-toast)
  - [ ] Success toast: "Client added successfully" (green)
  - [ ] Success toast: "Client updated successfully" (green)
  - [ ] Error toast: "Failed to save client. Please try again." (red)
  - [ ] Display toasts for 3 seconds
  - [ ] Position toasts at top-right

- [ ] **Task 8: Integration with Dashboard** (AC: 1)
  - [ ] Add state management for modal in `apps/web/src/app/clients/page.tsx`
  - [ ] "+ Add Client" button onClick → open modal in create mode
  - [ ] Client card edit button onClick → open modal in edit mode with client data
  - [ ] Pass props: isOpen, onClose, mode, client (if edit)

- [ ] **Task 9: Component Tests**
  - [ ] Test modal opens/closes correctly
  - [ ] Test form validation (required fields, email format, URL format)
  - [ ] Test Save button disabled when form invalid
  - [ ] Test Save button enabled when form valid
  - [ ] Test create client success flow
  - [ ] Test edit client success flow (pre-fill + update)
  - [ ] Test error handling (API errors)
  - [ ] Test tier limit warning display
  - [ ] Test unsaved changes confirmation on cancel

---

## Dev Notes

### Relevant Architecture

**Form Validation (from Story 2.1 schemas):**
```typescript
// packages/shared/schemas/client.ts
import { z } from 'zod';

export const ClientCreateSchema = z.object({
  name: z.string().min(2, 'Name must be at least 2 characters').max(100, 'Name must be less than 100 characters'),
  company: z.string().optional(),
  role: z.string().optional(),
  email: z.string().email('Invalid email format').optional().or(z.literal('')),
  phone: z.string().optional(),
  website: z.string().url('Invalid URL format').optional().or(z.literal('')),
  linkedin_url: z.string().url('Invalid URL format').optional().or(z.literal('')),
});

export const ClientUpdateSchema = ClientCreateSchema.partial().extend({
  id: z.string().uuid(),
});
```

**Component Library:**
- Shadcn Dialog for modal
- Shadcn Form components (Input, Label, Button)
- Shadcn Toast for notifications
- react-hook-form for form state
- @hookform/resolvers/zod for Zod integration

**State Management:**
- react-hook-form for form state
- @tanstack/react-query for API mutations
- Local state for modal open/close

**API Integration:**
- Create: POST /api/clients (returns created client)
- Update: PUT /api/clients/[id] (returns updated client)
- Errors: 400 (validation), 403 (tier limit), 409 (duplicate), 500 (server)

**Tier Limit Check:**
```typescript
// Fetch user preferences to check tier limit
const { data: userPrefs } = useQuery(['user-preferences'], async () => {
  const res = await fetch('/api/user/preferences');
  return res.json();
});

const clientCount = clients?.length || 0;
const canAddClient = clientCount < userPrefs.max_clients;
```

**Source Tree:**
- Modal: `apps/web/src/components/clients/ClientModal.tsx`
- Form: `apps/web/src/components/clients/ClientForm.tsx`
- Integration: `apps/web/src/app/clients/page.tsx` (state management)

### Testing

**Test Location:**
- Component tests: `apps/web/src/components/clients/__tests__/`

**Testing Standards:**
- Use Jest + Testing Library
- Mock react-hook-form submission
- Mock react-query mutations
- Mock toast library

**Specific Requirements:**
- Test form validation (all validation rules)
- Test modal open/close
- Test create/edit modes
- Test tier limit warning
- Test unsaved changes confirmation
- Test toast notifications

**Example Test Pattern:**
```typescript
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import ClientModal from '../ClientModal';

test('saves client when form is valid', async () => {
  const onClose = jest.fn();
  const mockMutate = jest.fn();

  render(<ClientModal isOpen={true} onClose={onClose} mode="create" />);

  fireEvent.change(screen.getByLabelText('Name'), { target: { value: 'Acme Corp' } });
  fireEvent.click(screen.getByText('Save'));

  await waitFor(() => {
    expect(mockMutate).toHaveBeenCalledWith({ name: 'Acme Corp' });
    expect(onClose).toHaveBeenCalled();
  });
});
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-07 | 1.0 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

### Agent Model Used

*TBD*

### Debug Log References

*TBD*

### Completion Notes List

*TBD*

### File List

*TBD*

---

## QA Results

*This section will be populated by the QA agent after story completion.*
