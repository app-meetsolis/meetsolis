# Story 2.3: Video Layout and Participant Management

## Status
Draft

## Story

**As a** host,
**I want** flexible video layouts and participant controls,
**so that** I can manage client meetings professionally and efficiently.

## Dependencies

**Required:**
- **Story 2.1** (WebRTC Infrastructure) - Video stream management
- **Story 2.2** (Video Controls) - Control mechanisms for participants

## Acceptance Criteria

1. Speaker view mode (default for 1:1 calls) with large speaker display
2. Gallery view mode for multi-participant meetings with grid layout
3. Pin participant functionality for personal focus
4. Spotlight participant feature for highlighting speakers to all
5. Participant panel with role indicators (host, co-host, participant)
6. Individual participant controls (mute, remove, promote to co-host)
7. Waiting room functionality with approve/reject controls
8. Meeting lock feature to prevent new joiners
9. Self-view toggle with draggable/resizable personal video
10. Immersive mode for distraction-free meetings

## Tasks / Subtasks

- [ ] **View Mode Management** (AC: 1, 2)
  - [ ] Create `useViewMode` hook in `src/hooks/meeting/`
  - [ ] Implement speaker view layout (1 large + small thumbnails)
  - [ ] Implement gallery view layout (equal-sized grid)
  - [ ] Add view mode toggle button in control bar
  - [ ] Auto-switch to speaker view for 1:1 calls
  - [ ] Auto-switch to gallery view for 3+ participants
  - [ ] Save view preference to localStorage
  - [ ] Write unit tests for view mode logic

- [ ] **Speaker View Component** (AC: 1)
  - [ ] Create `SpeakerView.tsx` component in `src/components/meeting/`
  - [ ] Implement large video area (75% width)
  - [ ] Add thumbnail strip for other participants (25% width)
  - [ ] Highlight active speaker automatically
  - [ ] Support manual speaker selection
  - [ ] Add smooth transitions when speaker changes
  - [ ] Ensure responsive design (mobile/tablet/desktop)
  - [ ] Write component tests

- [ ] **Gallery View Component** (AC: 2)
  - [ ] Create `GalleryView.tsx` component in `src/components/meeting/`
  - [ ] Implement responsive grid layout (1x1, 2x2, 3x3, 4x4)
  - [ ] Calculate optimal tile size based on participant count
  - [ ] Add pagination for >16 participants
  - [ ] Highlight speaking participants with border
  - [ ] Ensure equal sizing for all tiles
  - [ ] Add smooth transitions for layout changes
  - [ ] Write component tests

- [ ] **Pin/Spotlight Features** (AC: 3, 4)
  - [ ] Add pin icon to participant video tiles
  - [ ] Implement local pin (affects only current user's view)
  - [ ] Create API endpoint `/api/meetings/[id]/spotlight` (PUT)
  - [ ] Implement spotlight (affects all participants' views)
  - [ ] Sync spotlight state via Supabase Realtime
  - [ ] Add visual indicator for pinned/spotlighted participant
  - [ ] Allow unpinning/removing spotlight
  - [ ] Write API endpoint and sync tests

- [ ] **Participant Panel** (AC: 5, 6)
  - [ ] Create `ParticipantPanel.tsx` component in `src/components/meeting/`
  - [ ] Display participant list with avatars
  - [ ] Show role badges (host, co-host, participant)
  - [ ] Add connection quality indicators
  - [ ] Show mute/video status icons
  - [ ] Implement search/filter for large participant lists
  - [ ] Add participant count display
  - [ ] Ensure keyboard navigation and ARIA labels
  - [ ] Write component tests

- [ ] **Host Participant Controls** (AC: 6)
  - [ ] Add "..." menu button on each participant
  - [ ] Implement "Mute" action (uses Story 2.2 API)
  - [ ] Implement "Remove from meeting" action
  - [ ] Implement "Promote to co-host" action
  - [ ] Implement "Demote to participant" action
  - [ ] Add confirmation dialogs for destructive actions
  - [ ] Create API endpoint `/api/meetings/[id]/participants/[userId]/role` (PUT)
  - [ ] Create API endpoint `/api/meetings/[id]/participants/[userId]/remove` (DELETE)
  - [ ] Write API endpoint tests

- [ ] **Waiting Room Feature** (AC: 7)
  - [ ] Create database migration for waiting_room_participants table
  - [ ] Create API endpoint `/api/meetings/[id]/waiting-room` (GET)
  - [ ] Create API endpoint `/api/meetings/[id]/waiting-room/admit` (POST)
  - [ ] Create API endpoint `/api/meetings/[id]/waiting-room/reject` (DELETE)
  - [ ] Create `WaitingRoomPanel` component for hosts
  - [ ] Create `WaitingRoomView` component for waiting participants
  - [ ] Implement admit one/admit all functionality
  - [ ] Add real-time notifications for waiting room events
  - [ ] Show waiting count to host
  - [ ] Write API endpoint and component tests

- [ ] **Meeting Lock Feature** (AC: 8)
  - [ ] Add "Lock Meeting" toggle button in participant panel
  - [ ] Create API endpoint `/api/meetings/[id]/lock` (PUT)
  - [ ] Update meetings.locked field in database
  - [ ] Prevent new participants from joining when locked
  - [ ] Show lock status to all participants
  - [ ] Allow host to unlock meeting
  - [ ] Sync lock state via Supabase Realtime
  - [ ] Write API endpoint tests

- [ ] **Self-View Management** (AC: 9)
  - [ ] Create `SelfView.tsx` component in `src/components/meeting/`
  - [ ] Implement draggable self-view using react-draggable
  - [ ] Implement resizable self-view (3 size options: small, medium, large)
  - [ ] Add self-view hide/show toggle
  - [ ] Position self-view in bottom-right by default
  - [ ] Save self-view position/size to localStorage
  - [ ] Ensure self-view stays within viewport bounds
  - [ ] Write component tests for drag/resize

- [ ] **Immersive Mode** (AC: 10)
  - [ ] Add immersive mode toggle button (fullscreen icon)
  - [ ] Hide control bar in immersive mode (show on hover)
  - [ ] Hide participant panel in immersive mode
  - [ ] Hide self-view in immersive mode (or minimize)
  - [ ] Use browser Fullscreen API
  - [ ] Show subtle exit button
  - [ ] Add keyboard shortcut (F key) for immersive toggle
  - [ ] Write tests for immersive mode behavior

- [ ] **Database Schema Updates** (AC: 7, 8)
  - [ ] Create migration 007_add_waiting_room_and_spotlight.sql
  - [ ] Add waiting_room_participants table
  - [ ] Add spotlight_participant_id to meetings table
  - [ ] Update participants table with role change auditing
  - [ ] Add indexes for performance
  - [ ] Write migration tests

- [ ] **State Management & Sync** (AC: 4, 7, 8)
  - [ ] Create layout state types in `packages/shared/types/`
  - [ ] Implement layout state management with Context API
  - [ ] Sync spotlight state via Supabase Realtime
  - [ ] Sync waiting room state via Supabase Realtime
  - [ ] Sync meeting lock state via Supabase Realtime
  - [ ] Handle state conflicts and race conditions
  - [ ] Write state management tests

## Dev Notes

### Dependencies Context

**Story 2.1 Provides:**
- `ParticipantGrid` component for video tile layout
- `VideoTile` component for individual participants
- WebRTC stream management
- Participant tracking in database

**Story 2.2 Provides:**
- Control bar structure for adding layout toggles
- Mute participant API endpoint
- Real-time participant state sync patterns

**This story extends** the existing components with advanced layout options and host controls.

### Previous Story Insights

From **Story 2.2** (Video Controls):
- Control bar component structure
- Real-time state synchronization patterns
- API endpoint security (Zod, rate limiting, CSRF)
- Keyboard shortcuts with react-hotkeys-hook
- Accessibility requirements (WCAG 2.1 AA)

From **Story 2.1** (WebRTC Infrastructure):
- Participant state management
- Supabase Realtime for signaling
- Component architecture in `src/components/meeting/`

### Technology Stack

[Source: architecture/tech-stack.md]

**Additional Dependencies:**
- `react-draggable` ^4.4.6 - Draggable self-view
- `react-window` ^1.8.10 - Virtualized participant list for large meetings
- `framer-motion` ^10.18.0 - Layout transition animations

**Already Available:**
- `@tanstack/react-query` ^5.17.0 - State management
- `@supabase/realtime-js` ^2.9.3 - Real-time sync
- `react-hotkeys-hook` ^4.4.1 - Keyboard shortcuts

### Database Schema Updates

[Source: architecture/database-schema.md]

**New Table: waiting_room_participants**
```sql
CREATE TABLE waiting_room_participants (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    meeting_id UUID NOT NULL REFERENCES meetings(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    display_name TEXT NOT NULL,
    joined_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    status TEXT DEFAULT 'waiting' CHECK (status IN ('waiting', 'admitted', 'rejected')),
    UNIQUE(meeting_id, user_id)
);

CREATE INDEX idx_waiting_room_meeting_id ON waiting_room_participants(meeting_id);
CREATE INDEX idx_waiting_room_status ON waiting_room_participants(status);
```

**Meetings Table Update:**
```sql
ALTER TABLE meetings
ADD COLUMN spotlight_participant_id UUID REFERENCES participants(id) ON DELETE SET NULL;
```

**Participants Table Already Has:**
```sql
role TEXT DEFAULT 'participant' CHECK (role IN ('host', 'co-host', 'participant'))
```

### Component Architecture

[Source: architecture/frontend-architecture.md]

**New Components:**
- `src/components/meeting/SpeakerView.tsx` - Speaker-focused layout
- `src/components/meeting/GalleryView.tsx` - Grid layout
- `src/components/meeting/ParticipantPanel.tsx` - Participant list sidebar
- `src/components/meeting/WaitingRoomPanel.tsx` - Waiting room UI for hosts
- `src/components/meeting/WaitingRoomView.tsx` - Waiting UI for participants
- `src/components/meeting/SelfView.tsx` - Draggable/resizable self-view

**Hook Files:**
- `src/hooks/meeting/useViewMode.ts` - View mode management
- `src/hooks/meeting/useParticipantControls.ts` - Host control actions
- `src/hooks/meeting/useWaitingRoom.ts` - Waiting room logic

### View Mode Layouts

**Speaker View (1:1 or presentation mode):**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”
â”‚                             â”‚ 2â”‚
â”‚                             â”œâ”€â”€â”¤
â”‚            1                â”‚ 3â”‚
â”‚      (Active Speaker)       â”œâ”€â”€â”¤
â”‚                             â”‚ 4â”‚
â”‚                             â”œâ”€â”€â”¤
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”˜
```

**Gallery View (equal tiles):**
```
2 participants:     3-4 participants:   5-9 participants:
â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”
â”‚  1   â”‚  2   â”‚    â”‚  1   â”‚  2   â”‚    â”‚ 1  â”‚ 2  â”‚ 3  â”‚
â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜    â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¤
                    â”‚  3   â”‚  4   â”‚    â”‚ 4  â”‚ 5  â”‚ 6  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜    â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¤
                                        â”‚ 7  â”‚ 8  â”‚ 9  â”‚
                                        â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜
```

### API Endpoints

**Required Endpoints:**

1. **PUT `/api/meetings/[id]/spotlight`**
   - Set spotlight participant (visible to all)
   - Zod schema: `{ participant_id: string | null }`
   - Only host/co-host authorized
   - Returns: Updated meeting object

2. **PUT `/api/meetings/[id]/participants/[userId]/role`**
   - Promote/demote participant
   - Zod schema: `{ role: 'co-host' | 'participant' }`
   - Only host authorized
   - Returns: Updated participant object

3. **DELETE `/api/meetings/[id]/participants/[userId]/remove`**
   - Remove participant from meeting
   - Only host/co-host authorized
   - Sets leave_time in database
   - Returns: Success message

4. **PUT `/api/meetings/[id]/lock`**
   - Lock/unlock meeting
   - Zod schema: `{ locked: boolean }`
   - Only host authorized
   - Returns: Updated meeting object

5. **GET `/api/meetings/[id]/waiting-room`**
   - Get waiting participants list
   - Only host/co-host authorized
   - Returns: Array of waiting participants

6. **POST `/api/meetings/[id]/waiting-room/admit`**
   - Admit participant(s) from waiting room
   - Zod schema: `{ user_ids: string[] | 'all' }`
   - Only host/co-host authorized
   - Returns: Admitted participants

7. **DELETE `/api/meetings/[id]/waiting-room/reject`**
   - Reject participant from waiting room
   - Zod schema: `{ user_id: string }`
   - Only host/co-host authorized
   - Returns: Success message

**Security:**
- All endpoints require Clerk JWT authentication
- Host/co-host authorization checks
- Rate limiting: 100 req/min per user
- Input sanitization via Zod
- Audit logging for host actions

### Real-Time Synchronization

[Source: @supabase/realtime-js patterns]

**Events to Sync:**
1. Spotlight changes â†’ All participants
2. Waiting room admits/rejects â†’ Host + waiting participant
3. Meeting lock status â†’ All participants + waiting room
4. Participant role changes â†’ All participants
5. Participant removed â†’ Removed participant

```typescript
// Subscribe to meeting-level changes
const channel = supabase
  .channel(`meeting:${meetingId}`)
  .on('postgres_changes', {
    event: 'UPDATE',
    schema: 'public',
    table: 'meetings',
    filter: `id=eq.${meetingId}`
  }, (payload) => {
    // Handle spotlight or lock changes
    if (payload.new.spotlight_participant_id !== payload.old.spotlight_participant_id) {
      updateSpotlight(payload.new.spotlight_participant_id);
    }
    if (payload.new.locked !== payload.old.locked) {
      updateLockStatus(payload.new.locked);
    }
  })
  .subscribe();
```

### Participant Panel Features

**Information Displayed:**
- Participant name (with avatar/initials)
- Role badge (host/co-host)
- Connection quality (excellent/good/poor)
- Mute status icon (ðŸŽ¤ or ðŸ”‡)
- Video status icon (ðŸ“¹ or â›”)
- Speaking indicator (green dot when speaking)
- Hand raised indicator (âœ‹ - from Story 2.4)

**Host Controls (dropdown menu):**
- Mute/Unmute
- Turn off video (request)
- Promote to co-host
- Demote to participant
- Remove from meeting
- Pin (local view)
- Spotlight (all views)

### Waiting Room Flow

**Participant Experience:**
1. Click join meeting link
2. If waiting room enabled â†’ enter waiting room view
3. Show "Waiting for host to admit you..." message
4. Display host name and meeting title
5. Show estimated wait time (if available)
6. Notify when admitted or rejected

**Host Experience:**
1. See waiting room icon with count badge
2. Open waiting room panel
3. See list of waiting participants with names/avatars
4. "Admit" or "Reject" buttons for each
5. "Admit All" button at top
6. Real-time updates as participants join waiting room

### Immersive Mode

**What Hides:**
- Control bar (shows on hover/mouse move)
- Participant panel sidebar
- Self-view (or minimized to corner)
- Browser chrome (fullscreen API)

**What Stays:**
- Video tiles (full screen)
- Speaking indicators
- Participant names on hover

**Keyboard Shortcut:** `F` key (or `ESC` to exit)

### Accessibility Requirements

[Source: architecture/frontend-architecture.md]

**WCAG 2.1 AA Compliance:**
- All participant controls keyboard accessible
- ARIA labels for all buttons and icons
- Screen reader announcements for:
  - Participant joins/leaves
  - Role changes (promotion/demotion)
  - Spotlight changes
  - Meeting locked/unlocked
- Focus management in modals (waiting room panel)
- Visible focus indicators (2px outline)

**Keyboard Navigation:**
- Tab through participant list
- Enter/Space to open participant menu
- Arrow keys to navigate menu options
- Escape to close menus
- F key for immersive mode toggle

### State Management Pattern

```typescript
interface LayoutState {
  viewMode: 'speaker' | 'gallery';
  pinnedParticipantId: string | null; // Local
  spotlightParticipantId: string | null; // Synced
  selfViewVisible: boolean;
  selfViewPosition: { x: number; y: number };
  selfViewSize: 'small' | 'medium' | 'large';
  immersiveMode: boolean;
  participantPanelOpen: boolean;
}

interface WaitingRoomState {
  participants: WaitingParticipant[];
  count: number;
  panelOpen: boolean;
}
```

### Performance Considerations

- **Large Participant Lists:** Use react-window for virtualization (>50 participants)
- **Layout Transitions:** Use CSS transforms for smooth animations
- **Drag/Resize:** Throttle position updates to 60 FPS
- **Real-Time Updates:** Debounce UI updates for rapid state changes
- **Video Tile Rendering:** Use React.memo to prevent unnecessary re-renders

### Testing Strategy

**Test File Locations:**
- Component tests: `src/components/meeting/__tests__/`
- Hook tests: `src/hooks/meeting/__tests__/`
- API tests: `src/app/api/meetings/__tests__/`
- E2E tests: `tests/e2e/meeting/`

**Testing Standards:**

1. **View Mode Tests:**
   - Test speaker view layout
   - Test gallery view layout
   - Test view mode switching
   - Test responsive grid calculations

2. **Participant Control Tests:**
   - Test participant menu actions
   - Test role promotion/demotion
   - Test participant removal
   - Test authorization (only host can remove)

3. **Waiting Room Tests:**
   - Test admit participant flow
   - Test reject participant flow
   - Test real-time waiting room updates
   - Test admit all functionality

4. **Layout Tests:**
   - Test pin/spotlight behavior
   - Test self-view drag/resize
   - Test immersive mode toggle
   - Test layout persistence

5. **API Endpoint Tests:**
   - Test all 7 new endpoints
   - Test Zod validation
   - Test authorization checks
   - Test rate limiting
   - Mock Supabase client

6. **Accessibility Tests:**
   - Test keyboard navigation
   - Test screen reader announcements
   - Test ARIA labels
   - Use @axe-core/react

**Mock Strategies:**
```typescript
// Mock participant data
const mockParticipants = [
  { id: '1', role: 'host', is_muted: false, connection_quality: 'good' },
  { id: '2', role: 'participant', is_muted: true, connection_quality: 'excellent' },
  // ...
];

// Mock Supabase Realtime
const mockChannel = {
  on: jest.fn().mockReturnThis(),
  subscribe: jest.fn(),
};
```

### Browser Compatibility

- **Fullscreen API:** Supported in all modern browsers
- **Drag/Drop:** Full support via react-draggable
- **Grid Layouts:** CSS Grid supported everywhere
- **Real-Time:** WebSocket support required

### Known Constraints

1. **Participant Limit:** Gallery view optimized for <25 participants. Pagination required for larger meetings.
2. **Mobile Drag:** Self-view drag may be awkward on mobile - simplified positioning in Story 2.7.
3. **Spotlight Conflicts:** Only one spotlight at a time. Pinning is per-user.
4. **Waiting Room:** Host must be present to admit participants.

### Testing

**Key Test Scenarios:**
1. Switch between speaker and gallery views
2. Pin participant for local focus
3. Spotlight participant for all viewers
4. Host promotes participant to co-host
5. Host removes disruptive participant
6. Host admits participant from waiting room
7. Host locks meeting to prevent new joins
8. Drag and resize self-view
9. Toggle immersive mode on/off
10. Accessibility: navigate participant panel with keyboard

**Success Criteria:**
- All view modes render correctly
- Host controls work as expected
- Waiting room flow functions end-to-end
- Real-time sync working (<1s latency)
- Accessibility tests pass
- No layout jank or performance issues

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-13 | 1.0 | Initial story creation for video layouts and participant management | Bob (Scrum Master) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results

*Results from QA Agent review will be populated here after story completion*
