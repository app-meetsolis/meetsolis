# Story 2.8: Client Deletion & Cascading

## Status

Draft

---

## Story

**As a** user,
**I want** to delete clients I no longer work with,
**so that** I can keep my client list clean.

---

## Acceptance Criteria

1. Delete button in client detail dropdown menu
2. Confirmation dialog: "Are you sure? This will delete [Client Name] and all associated meetings, notes, and action items. This action cannot be undone."
3. Checkbox: "I understand this is permanent"
4. Delete button enabled only after checkbox checked
5. Cascade delete: meetings, action_items, embeddings (vector data), notes
6. Success toast: "Client deleted successfully"
7. Redirect to clients dashboard
8. Undo option (30-second window before hard delete - future enhancement)

---

## Tasks / Subtasks

- [ ] **Task 1: Delete Confirmation Dialog** (AC: 2, 3, 4)
  - [ ] Create `apps/web/src/components/clients/DeleteClientDialog.tsx`
  - [ ] Use Shadcn AlertDialog component
  - [ ] Props: `isOpen`, `onClose`, `onConfirm`, `clientName`
  - [ ] Display warning message with client name
  - [ ] Add checkbox: "I understand this is permanent"
  - [ ] Disable "Delete" button until checkbox checked
  - [ ] Add "Cancel" and "Delete" buttons
  - [ ] "Delete" button should be red/destructive style

- [ ] **Task 2: Delete Button in Client Detail** (AC: 1)
  - [ ] Update `ClientDetailHeader.tsx` (Story 2.6)
  - [ ] Add "Delete" option in dropdown menu
  - [ ] onClick â†’ Open DeleteClientDialog
  - [ ] Pass client.name to dialog

- [ ] **Task 3: Delete API Logic** (AC: 5)
  - [ ] Verify DELETE /api/clients/[id] route exists (Story 2.1)
  - [ ] Verify CASCADE delete configured at database level:
    - `meetings` table: `client_id` FK with ON DELETE CASCADE
    - `action_items` table: `client_id` FK with ON DELETE CASCADE
    - `embeddings` table: `client_id` FK with ON DELETE CASCADE
  - [ ] Delete client record (database automatically cascades)
  - [ ] Return 204 No Content on success

- [ ] **Task 4: Cascade Delete Verification** (AC: 5)
  - [ ] Verify database schema has CASCADE constraints:
    ```sql
    -- meetings table
    client_id UUID NOT NULL REFERENCES clients(id) ON DELETE CASCADE

    -- action_items table
    client_id UUID NOT NULL REFERENCES clients(id) ON DELETE CASCADE

    -- embeddings table
    client_id UUID REFERENCES clients(id) ON DELETE CASCADE
    ```
  - [ ] Test cascade delete: Create client with meetings/action items, delete client, verify all deleted

- [ ] **Task 5: Delete Client Flow** (AC: 6, 7)
  - [ ] Implement onConfirm handler in DeleteClientDialog
  - [ ] Call DELETE /api/clients/[id]
  - [ ] Handle success:
    - Show toast: "Client deleted successfully"
    - Redirect to `/clients` dashboard
    - Invalidate react-query cache for ['clients']
  - [ ] Handle error:
    - Show toast: "Failed to delete client. Please try again."
    - Keep dialog open for retry

- [ ] **Task 6: Success Toast** (AC: 6)
  - [ ] Use toast library (from Story 2.3)
  - [ ] Display toast: "Client deleted successfully"
  - [ ] Toast style: Success (green)
  - [ ] Toast duration: 3 seconds
  - [ ] Position: Top-right

- [ ] **Task 7: Redirect After Delete** (AC: 7)
  - [ ] Use Next.js router.push('/clients')
  - [ ] Redirect after successful delete
  - [ ] Ensure redirect happens after toast displays

- [ ] **Task 8: Loading State** (AC: 4)
  - [ ] Show loading spinner on "Delete" button during API call
  - [ ] Disable "Delete" button during deletion
  - [ ] Prevent closing dialog during deletion

- [ ] **Task 9: Component Tests**
  - [ ] Test dialog opens with client name
  - [ ] Test checkbox enables delete button
  - [ ] Test delete API call on confirm
  - [ ] Test success toast display
  - [ ] Test redirect to /clients on success
  - [ ] Test error handling (delete failure)
  - [ ] Test cascade delete (database integration test)

- [ ] **Task 10: Integration Test - Cascade Delete** (AC: 5)
  - [ ] Create integration test: `client-cascade-delete.test.ts`
  - [ ] Test scenario:
    1. Create client
    2. Create meeting for client
    3. Create action item for client
    4. Delete client
    5. Verify client deleted
    6. Verify meeting deleted (CASCADE)
    7. Verify action item deleted (CASCADE)

---

## Dev Notes

### Relevant Architecture

**Database CASCADE Constraints:**
```sql
-- Defined in v2.0 migration (migrate-v2.sql)

CREATE TABLE meetings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  client_id UUID NOT NULL REFERENCES clients(id) ON DELETE CASCADE,
  -- ... other fields
);

CREATE TABLE action_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  client_id UUID NOT NULL REFERENCES clients(id) ON DELETE CASCADE,
  -- ... other fields
);

CREATE TABLE embeddings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  client_id UUID REFERENCES clients(id) ON DELETE CASCADE,
  -- ... other fields
);
```

**Delete Flow:**
1. User clicks "Delete" in client detail dropdown
2. DeleteClientDialog opens
3. User checks "I understand this is permanent"
4. User clicks "Delete" button
5. API call: DELETE /api/clients/[id]
6. Database deletes client + cascades to meetings, action_items, embeddings
7. Success toast displayed
8. Redirect to /clients dashboard

**Component Library:**
- Shadcn AlertDialog for confirmation
- Shadcn Checkbox for confirmation checkbox
- Shadcn Button (destructive variant) for delete button
- Shadcn Toast for success/error messages

**API Integration:**
- DELETE /api/clients/[id]
- Returns 204 No Content on success
- Returns 404 if client not found
- Returns 500 on server error

**Source Tree:**
- Dialog component: `apps/web/src/components/clients/DeleteClientDialog.tsx`
- Integration: `apps/web/src/app/clients/[id]/page.tsx` (ClientDetailHeader)
- API route: `apps/web/src/app/api/clients/[id]/route.ts` (DELETE handler)

**Future Enhancement (AC: 8):**
- Undo option: Soft delete for 30 seconds before hard delete
- Implementation: Add `deleted_at` timestamp field, filter out deleted clients, background job to hard delete after 30 seconds
- Not included in this story (future Epic)

### Testing

**Test Location:**
- Component tests: `apps/web/src/components/clients/__tests__/`
- Integration tests: `apps/web/tests/integration/clients/`

**Testing Standards:**
- Use Jest + Testing Library for component tests
- Use Supabase test client for cascade delete tests
- Mock Next.js router for redirect tests

**Specific Requirements:**
- Test confirmation dialog UI
- Test checkbox enables delete button
- Test delete API call
- Test success/error toasts
- Test redirect after delete
- **Test cascade delete** (critical - verify related records deleted)

**Example Cascade Delete Test:**
```typescript
import { createClient } from '@supabase/supabase-js';

test('deletes client and cascades to meetings and action items', async () => {
  const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);

  // Create client
  const { data: client } = await supabase
    .from('clients')
    .insert({ user_id: testUserId, name: 'Test Client' })
    .select()
    .single();

  // Create meeting
  await supabase
    .from('meetings')
    .insert({ user_id: testUserId, client_id: client.id, title: 'Test Meeting' });

  // Create action item
  await supabase
    .from('action_items')
    .insert({ user_id: testUserId, client_id: client.id, description: 'Test Task' });

  // Delete client
  await supabase.from('clients').delete().eq('id', client.id);

  // Verify cascade delete
  const { data: meetings } = await supabase
    .from('meetings')
    .select()
    .eq('client_id', client.id);

  const { data: actionItems } = await supabase
    .from('action_items')
    .select()
    .eq('client_id', client.id);

  expect(meetings).toEqual([]);
  expect(actionItems).toEqual([]);
});
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-07 | 1.0 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

---

## QA Results

*This section will be populated by the QA agent after story completion.*
