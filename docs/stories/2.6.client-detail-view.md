# Story 2.6: Client Detail View (Enhanced)

## Status

Approved

---

## Story

**As a** user,
**I want** to view detailed client information with action items tracking,
**so that** I can see all context and follow-ups for a specific client.

---

## Acceptance Criteria

1. Client detail page: `/clients/[id]`
2. Header: Back button, Client name, Role/Company, Tags, Action buttons (Prep for Meeting, Edit, Delete)
3. **Main Content (Left 2/3):**
   - Tabbed interface: Overview | Meeting History | Notes & Decisions
   - Overview tab: Client info + AI overview placeholder
   - Meeting History tab: Empty state ("No meetings yet")
   - Notes & Decisions tab: Rich text editor (Story 2.7)
4. **Action Items Sidebar (Right 1/3):**
   - Title: "Action Items" with count badge
   - List with checkboxes (check → strikethrough + gray)
   - Each item: Description, due date badge
   - Empty state: "No action items yet"
   - "+ Add Action Item" button (manual creation)
5. **Next Steps Section (Below Action Items):**
   - Title: "Next Steps"
   - Bulleted list (manual entry initially, AI in Epic 4)
   - Placeholder: "Next steps will appear after logging meetings"
6. **Responsive:** Desktop 2-column, tablet/mobile stacked
7. 404 handling, RLS access control

---

## Tasks / Subtasks

- [ ] **Task 0: Database Migration** (AC: 4, 5)
  - [ ] Verify if `action_items` table already exists from previous stories
  - [ ] Create migration: `supabase/migrations/YYYYMMDDHHMMSS_add_action_items_and_next_steps.sql`
  - [ ] Create `action_items` table:
    ```sql
    CREATE TABLE IF NOT EXISTS action_items (
      id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
      client_id UUID NOT NULL REFERENCES clients(id) ON DELETE CASCADE,
      user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
      description TEXT NOT NULL CHECK (LENGTH(TRIM(description)) > 0),
      completed BOOLEAN DEFAULT FALSE,
      due_date DATE,
      created_at TIMESTAMPTZ DEFAULT NOW(),
      updated_at TIMESTAMPTZ DEFAULT NOW()
    );

    CREATE INDEX idx_action_items_client_id ON action_items(client_id);
    CREATE INDEX idx_action_items_user_id ON action_items(user_id);
    ```
  - [ ] Add RLS policies for action_items:
    ```sql
    ALTER TABLE action_items ENABLE ROW LEVEL SECURITY;

    CREATE POLICY "Users can only access their own action items"
      ON action_items FOR ALL
      USING (user_id = auth.uid());
    ```
  - [ ] Add `next_steps` JSONB field to clients table:
    ```sql
    ALTER TABLE clients ADD COLUMN IF NOT EXISTS next_steps JSONB DEFAULT '[]'::jsonb;
    ```
  - [ ] Add trigger for action_items updated_at
  - [ ] Run migration in development environment
  - [ ] Verify tables/columns accessible via Supabase client

- [ ] **Task 1: 2-Column Responsive Layout** (AC: 3, 4, 6)
  - [ ] Create `apps/web/src/components/clients/ClientDetailLayout.tsx`
  - [ ] Desktop (≥1024px): 2-column layout (Main 2/3 + Sidebar 1/3)
  - [ ] Tablet/Mobile (<1024px): Stacked layout (Main → Sidebar)
  - [ ] Use CSS Grid or Flexbox: `grid-cols-1 lg:grid-cols-3`, main `lg:col-span-2`, sidebar `lg:col-span-1`
  - [ ] Responsive gap: 24px desktop, 16px mobile
  - [ ] Props: `children` (main content), `sidebar` (action items + next steps)
  - [ ] Sticky sidebar on desktop (optional): `position: sticky; top: 24px;`

- [ ] **Task 2: Client Detail Page** (AC: 1, 7)
  - [ ] Create `apps/web/src/app/(dashboard)/clients/[id]/page.tsx`
  - [ ] Add page metadata: `generateMetadata()` with dynamic title `{Client Name} | MeetSolis`
  - [ ] Fetch client data: `GET /api/clients/[id]`
  - [ ] Fetch action items: `GET /api/action-items?client_id={id}`
  - [ ] Handle loading state (skeleton matching 2-column layout)
  - [ ] Handle 404: Client not found or doesn't belong to user
  - [ ] Handle error state with retry button
  - [ ] Protect route (middleware ensures auth)
  - [ ] Use ClientDetailLayout wrapper

- [ ] **Task 3: Client Detail Header** (AC: 2)
  - [ ] Create `apps/web/src/components/clients/ClientDetailHeader.tsx`
  - [ ] Display back button (← ArrowLeft icon) → navigate to `/clients`
  - [ ] Display client name (text-2xl font-bold)
  - [ ] Display role/company below name (text-sm text-gray-600)
  - [ ] Display tags as TagPill components (from Story 2.5)
  - [ ] Add action buttons (top-right):
    - "Prepare for Meeting" button (primary, links to Epic 3 feature - disabled for now)
    - Dropdown menu (MoreVertical icon) with "Edit" and "Delete" options
  - [ ] Responsive: Stack vertically on mobile (<640px)

- [ ] **Task 4: Tabbed Interface** (AC: 3)
  - [ ] Create `apps/web/src/components/clients/ClientTabs.tsx`
  - [ ] Use Shadcn Tabs component
  - [ ] Tabs: "Overview", "Meeting History", "Notes & Decisions"
  - [ ] Default active tab: "Overview"
  - [ ] URL reflects active tab: `/clients/[id]?tab=overview`
  - [ ] Tab content changes based on active tab
  - [ ] Keyboard navigation: Arrow keys to switch tabs

- [ ] **Task 5: Overview Tab** (AC: 3)
  - [ ] Create `apps/web/src/components/clients/ClientOverview.tsx`
  - [ ] Display client information in 2-column grid (desktop) or stacked (mobile):
    - Name, Company, Role
    - Email (with mailto: link), Phone (with tel: link)
    - Website (with external link icon, opens in new tab)
    - LinkedIn URL (with external link icon, opens in new tab)
    - Tags (as TagPill components)
    - Created date, Last updated date (formatted: "Jan 12, 2026")
  - [ ] Add placeholder for AI-generated overview:
    - Empty state card: "AI overview will be generated after your first meeting." (text-gray-500)
    - Gray background (#F9FAFB), dashed border
    - Future: Will be populated in Epic 4

- [ ] **Task 6: Meeting History Tab Empty State** (AC: 3)
  - [ ] Create `apps/web/src/components/clients/MeetingHistoryTabEmpty.tsx`
  - [ ] Display empty state when no meetings exist for client
  - [ ] Center-aligned message: "No meetings yet"
  - [ ] Subtext: "Log your first meeting to see it here."
  - [ ] Add "+ Log Meeting" button (links to Epic 3 feature - disabled/grayed for now)
  - [ ] Add illustration/icon (Calendar or Video icon from Lucide)
  - [ ] Future: Epic 3 will populate with meeting cards

- [ ] **Task 7: Notes & Decisions Tab Integration** (AC: 3)
  - [ ] Add "Notes & Decisions" tab to ClientTabs
  - [ ] Tab content: Placeholder component for now
  - [ ] Display message: "Notes editor will be implemented in Story 2.7"
  - [ ] Story 2.7 will replace with rich text editor (Tiptap)

- [ ] **Task 8: Action Items Sidebar Component** (AC: 4)
  - [ ] Create `apps/web/src/components/clients/ClientActionItemsSidebar.tsx`
  - [ ] Props: `clientId: string`, `actionItems: ActionItem[]`, `onActionItemsChange: () => void`
  - [ ] Header: "Action Items" title with count badge (e.g., "Action Items (3)")
  - [ ] Empty state: "No action items yet" with gray text
  - [ ] Display action items as ActionItemCard components (from Task 9)
  - [ ] "+ Add Action Item" button at bottom (opens modal or inline input)
  - [ ] Scrollable list if >5 items: `max-height: 400px; overflow-y: auto;`
  - [ ] Accessibility: `role="region"`, `aria-label="Action items for this client"`

- [ ] **Task 9: ActionItemCard Component** (AC: 4)
  - [ ] Create `apps/web/src/components/clients/ActionItemCard.tsx`
  - [ ] Props: `actionItem: ActionItem`, `onToggle: () => void`, `onEdit: () => void`, `onDelete: () => void`
  - [ ] Display checkbox (Shadcn Checkbox component)
  - [ ] Display description (strikethrough + gray if completed)
  - [ ] Display due date badge (if exists): Format "Jan 12", red if overdue, gray if completed
  - [ ] Hover actions: Edit icon, Delete icon (visible on hover)
  - [ ] Keyboard navigation: Tab to focus, Enter/Space to toggle checkbox, Delete key to delete
  - [ ] Accessibility: `aria-label="Mark action item as complete"`, `aria-checked={completed}`

- [ ] **Task 10: Action Item CRUD Functionality** (AC: 4)
  - [ ] Create action item modal/dialog: `ClientActionItemModal.tsx`
  - [ ] Form fields: Description (required, max 500 chars), Due date (optional, date picker)
  - [ ] Validation: Zod schema for action items
  - [ ] Create action item: POST /api/action-items
  - [ ] Update action item: PUT /api/action-items/[id] (for editing description/due date)
  - [ ] Toggle checkbox: PUT /api/action-items/[id] (toggle completed boolean)
  - [ ] Delete action item: DELETE /api/action-items/[id] with confirmation dialog
  - [ ] Optimistic updates: Update UI immediately, revert on error
  - [ ] Success/error toasts for all operations

- [ ] **Task 11: Next Steps Section Component** (AC: 5)
  - [ ] Create `apps/web/src/components/clients/ClientNextSteps.tsx`
  - [ ] Props: `clientId: string`, `nextSteps: string[]`, `onNextStepsChange: (steps: string[]) => void`
  - [ ] Header: "Next Steps" title
  - [ ] Display as bulleted list (`ul` with `li` elements)
  - [ ] Empty state: "Next steps will appear after logging meetings" (gray, italic)
  - [ ] Show "+ Add Next Step" button if list empty or on hover
  - [ ] Each step: Editable inline or via modal (click to edit)
  - [ ] Delete step: X icon on hover
  - [ ] Accessibility: `role="list"`, keyboard navigation (Tab, Enter to edit, Delete to remove)

- [ ] **Task 12: Next Steps Editing Functionality** (AC: 5)
  - [ ] Inline editing: Click step → convert to input field → Save on Enter or blur
  - [ ] Add step: Click "+ Add Next Step" → show input field → Save on Enter
  - [ ] Delete step: Click X icon → remove from list (no confirmation needed)
  - [ ] Update next steps: PUT /api/clients/[id]/next-steps
  - [ ] Request body: `{ next_steps: string[] }`
  - [ ] Validation: Max 10 steps, max 200 chars per step
  - [ ] Debounced save (500ms) to prevent excessive API calls
  - [ ] Optimistic updates with error handling

- [ ] **Task 13: Action Items API Routes** (AC: 4)
  - [ ] Create `apps/web/src/app/api/action-items/route.ts`
    - GET: List action items for client: `?client_id={id}` (with RLS filter)
    - POST: Create action item (validate client_id, user_id, description)
  - [ ] Create `apps/web/src/app/api/action-items/[id]/route.ts`
    - GET: Get single action item (RLS enforced)
    - PUT: Update action item (description, due_date, completed)
    - DELETE: Delete action item (RLS enforced)
  - [ ] Zod validation schema:
    ```typescript
    const actionItemSchema = z.object({
      client_id: z.string().uuid(),
      description: z.string().min(1).max(500),
      due_date: z.string().datetime().optional(),
      completed: z.boolean().default(false),
    });
    ```
  - [ ] Error handling: 400 (validation), 404 (not found), 500 (server error)
  - [ ] RLS enforced at database level

- [ ] **Task 14: Next Steps API Route** (AC: 5)
  - [ ] Create `apps/web/src/app/api/clients/[id]/next-steps/route.ts`
  - [ ] PUT: Update next steps for client
    - Request body: `{ next_steps: string[] }`
    - Validation: Max 10 steps, max 200 chars per step
    - Update `clients.next_steps` JSONB field
  - [ ] Zod validation:
    ```typescript
    const nextStepsSchema = z.object({
      next_steps: z.array(z.string().max(200)).max(10),
    });
    ```
  - [ ] Return updated client object
  - [ ] RLS enforced (user can only update their own clients)

- [ ] **Task 15: Edit/Delete Client Integration** (AC: 2)
  - [ ] Add "Edit" option in dropdown menu
  - [ ] onClick → Open ClientForm modal in edit mode (Story 2.3)
  - [ ] Pass current client data to modal
  - [ ] After save, refetch client data to update view
  - [ ] Add "Delete" option in dropdown menu
  - [ ] onClick → Open confirmation dialog (implemented in Story 2.8)
  - [ ] After delete, redirect to `/clients` dashboard

- [ ] **Task 16: Loading & Error States** (AC: 1, 7)
  - [ ] Create loading skeleton for client detail page
  - [ ] Skeleton matches 2-column layout (main + sidebar)
  - [ ] Skeleton for header, tabs, action items sidebar, next steps
  - [ ] Error state component for failed client fetch (with retry button)
  - [ ] 404 state component: "Client not found" with link back to `/clients`
  - [ ] Loading states for action items CRUD operations (spinner on button)

- [ ] **Task 17: Component Tests**
  - [ ] Create `apps/web/src/app/(dashboard)/clients/[id]/__tests__/page.test.tsx`
    - Test: Client detail page renders with client data
    - Test: 404 handling (client not found)
    - Test: Access control (user can't view other user's client)
    - Test: Tab switching (URL params)
    - Test: Back button navigation
  - [ ] Create `apps/web/src/components/clients/__tests__/ClientActionItemsSidebar.test.tsx`
    - Test: Renders action items list
    - Test: Empty state displayed when no items
    - Test: Count badge shows correct number
    - Test: "+ Add Action Item" button opens modal
  - [ ] Create `apps/web/src/components/clients/__tests__/ActionItemCard.test.tsx`
    - Test: Checkbox toggle calls onToggle
    - Test: Completed items show strikethrough
    - Test: Due date badge displays correctly
    - Test: Overdue items show red badge
    - Test: Edit/Delete actions work
    - Test: Keyboard navigation (Tab, Enter, Delete)
  - [ ] Create `apps/web/src/components/clients/__tests__/ClientNextSteps.test.tsx`
    - Test: Renders next steps list
    - Test: Empty state displayed
    - Test: Add step functionality
    - Test: Edit step inline
    - Test: Delete step
  - [ ] Integration tests:
    - Test: Create action item → appears in sidebar
    - Test: Toggle action item → updates database
    - Test: Delete action item → removed from sidebar
    - Test: Update next steps → saved to database
    - Test: 2-column layout responsive behavior (desktop vs mobile)

---

## Dev Notes

### Relevant Architecture

**Layout Structure:**
```
┌─────────────────────────────────┬──────────────────┐
│ ← Back   Client Name            │  ACTION ITEMS (3)│
│ Tags: [VIP] [Active]            │  [ ] Task 1      │
│                                  │  [✓] Task 2      │
│ Tabs: Overview | Meeting        │  [ ] Task 3      │
│       History | Notes            │  + Add Item      │
│                                  ├──────────────────┤
│ [Tab Content - 2/3 width]       │  NEXT STEPS      │
│                                  │  • Step 1        │
│                                  │  • Step 2        │
│                                  │  + Add Step      │
└──────────────────────────────────┴──────────────────┘

Mobile (<1024px): Stacked layout
┌─────────────────────────────────┐
│ ← Back   Client Name            │
│ Tags: [VIP] [Active]            │
│                                  │
│ Tabs: Overview | Meeting        │
│       History | Notes            │
│                                  │
│ [Tab Content - Full width]      │
│                                  │
├──────────────────────────────────┤
│  ACTION ITEMS (3)                │
│  [ ] Task 1                      │
│  [✓] Task 2                      │
│  + Add Item                      │
├──────────────────────────────────┤
│  NEXT STEPS                      │
│  • Step 1                        │
│  + Add Step                      │
└──────────────────────────────────┘
```

**Database Schema:**

From `docs/architecture/database-schema.md`:

```sql
-- Action Items Table (New)
CREATE TABLE action_items (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  client_id UUID NOT NULL REFERENCES clients(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  description TEXT NOT NULL CHECK (LENGTH(TRIM(description)) > 0),
  completed BOOLEAN DEFAULT FALSE,
  due_date DATE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes for performance
CREATE INDEX idx_action_items_client_id ON action_items(client_id);
CREATE INDEX idx_action_items_user_id ON action_items(user_id);

-- RLS Policies
ALTER TABLE action_items ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can only access their own action items"
  ON action_items FOR ALL
  USING (user_id = auth.uid());

-- Next Steps Field (Update to clients table)
ALTER TABLE clients ADD COLUMN next_steps JSONB DEFAULT '[]'::jsonb;

-- Example stored values:
-- action_items: { id, client_id, description: "Follow up on proposal", completed: false, due_date: "2026-01-15" }
-- next_steps: ["Send pricing quote", "Schedule demo call", "Prepare contract"]
```

**TypeScript Types:**

Create in `packages/shared/src/types/index.ts`:

```typescript
export interface ActionItem {
  id: string;
  client_id: string;
  user_id: string;
  description: string;
  completed: boolean;
  due_date?: string; // ISO date string
  created_at: string;
  updated_at: string;
}

// Extend Client type
export interface Client {
  // ... existing fields
  next_steps?: string[]; // Array of next step strings
}
```

**API Routes:**

```
GET    /api/action-items?client_id={id}     - List action items for client
POST   /api/action-items                    - Create action item
GET    /api/action-items/[id]               - Get single action item
PUT    /api/action-items/[id]               - Update action item
DELETE /api/action-items/[id]               - Delete action item

PUT    /api/clients/[id]/next-steps         - Update next steps array
```

**Validation Schemas:**

Create in `apps/web/src/lib/validations/actionItems.ts`:

```typescript
import { z } from 'zod';

export const actionItemSchema = z.object({
  client_id: z.string().uuid(),
  description: z.string().min(1, 'Description required').max(500, 'Max 500 characters'),
  due_date: z.string().datetime().optional(),
  completed: z.boolean().default(false),
});

export const nextStepsSchema = z.object({
  next_steps: z
    .array(z.string().max(200, 'Max 200 characters per step'))
    .max(10, 'Max 10 next steps'),
});
```

**Component Library:**

- **Shadcn Tabs** - Tabbed interface
- **Shadcn Checkbox** - Action item checkboxes
- **Shadcn Dialog** - Action item create/edit modal
- **Shadcn DropdownMenu** - Edit/Delete actions
- **Shadcn Button** - All buttons (Add, Edit, Delete, etc.)
- **Shadcn Badge** - Count badge, due date badges
- **Lucide icons**: ArrowLeft, MoreVertical, Plus, Edit, Trash2, Calendar, ExternalLink

**Source Tree:**

```
apps/web/src/
├── app/
│   ├── (dashboard)/clients/[id]/
│   │   ├── page.tsx                          # Client detail page (NEW)
│   │   └── __tests__/page.test.tsx           # Page tests (NEW)
│   └── api/
│       ├── action-items/
│       │   ├── route.ts                      # GET (list), POST (create) (NEW)
│       │   └── [id]/route.ts                 # GET, PUT, DELETE (NEW)
│       └── clients/[id]/next-steps/
│           └── route.ts                      # PUT (update next steps) (NEW)
├── components/clients/
│   ├── ClientDetailLayout.tsx                # 2-column responsive wrapper (NEW)
│   ├── ClientDetailHeader.tsx                # Header with back, actions (NEW)
│   ├── ClientTabs.tsx                        # Tabbed interface (NEW)
│   ├── ClientOverview.tsx                    # Overview tab content (NEW)
│   ├── MeetingHistoryTabEmpty.tsx            # Meeting history empty state (NEW)
│   ├── ClientActionItemsSidebar.tsx          # Action items sidebar (NEW)
│   ├── ActionItemCard.tsx                    # Single action item (NEW)
│   ├── ClientActionItemModal.tsx             # Create/edit action item (NEW)
│   ├── ClientNextSteps.tsx                   # Next steps section (NEW)
│   └── __tests__/
│       ├── ClientActionItemsSidebar.test.tsx # Sidebar tests (NEW)
│       ├── ActionItemCard.test.tsx           # Action item tests (NEW)
│       └── ClientNextSteps.test.tsx          # Next steps tests (NEW)
├── lib/validations/
│   └── actionItems.ts                        # Zod schemas (NEW)
└── hooks/
    └── useActionItems.ts                     # Custom hook for action items (NEW)
```

**Responsive Layout Implementation:**

```typescript
// ClientDetailLayout.tsx
export function ClientDetailLayout({
  children,
  sidebar
}: {
  children: React.ReactNode;
  sidebar: React.ReactNode;
}) {
  return (
    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
      {/* Main content - 2/3 on desktop */}
      <div className="lg:col-span-2">
        {children}
      </div>

      {/* Sidebar - 1/3 on desktop, full width on mobile */}
      <div className="lg:col-span-1 space-y-6">
        {sidebar}
      </div>
    </div>
  );
}
```

**Accessibility Requirements:**

From `docs/architecture/coding-standards.md`:

- **Action Items Sidebar**: `role="region"`, `aria-label="Action items for this client"`
- **Action Item Checkbox**: `aria-label="Mark action item as complete"`, `aria-checked={completed}`
- **Next Steps**: `role="list"`, `aria-label="Next steps for this client"`
- **Keyboard Navigation**:
  - Tab: Navigate between action items, next steps
  - Enter/Space: Toggle checkbox, activate edit
  - Delete: Remove action item or next step
  - Escape: Cancel inline editing
- **Screen Reader**: Announce count badge changes, action item status changes

**Performance Considerations:**

```typescript
// Memoize action items by completion status
const { completedItems, pendingItems } = useMemo(() => {
  const completed = actionItems.filter(item => item.completed);
  const pending = actionItems.filter(item => !item.completed);
  return { completedItems: completed, pendingItems: pending };
}, [actionItems]);

// Debounce next steps updates (500ms)
const debouncedUpdateNextSteps = useDebounce((steps: string[]) => {
  updateNextSteps(steps);
}, 500);

// Optimistic updates for checkbox toggle
const handleToggleActionItem = async (itemId: string) => {
  // Update UI immediately
  setActionItems(prev =>
    prev.map(item =>
      item.id === itemId ? { ...item, completed: !item.completed } : item
    )
  );

  try {
    // Send API request
    await toggleActionItem(itemId);
  } catch (error) {
    // Revert on error
    setActionItems(prev =>
      prev.map(item =>
        item.id === itemId ? { ...item, completed: !item.completed } : item
      )
    );
    toast.error('Failed to update action item');
  }
};
```

**Important Notes:**

- Story 2.7 will implement the "Notes & Decisions" tab (rich text editor)
- Story 2.8 will implement the Delete confirmation dialog
- Epic 3 will populate the "Meeting History" tab with meeting cards
- Epic 3 will auto-generate action items from meeting transcripts
- Epic 4 will auto-populate AI overview and AI-generated next steps
- Action items created in this story are **manual** (user-created), AI-generated action items come in Epic 3

### Testing

**Test Location:**

From `docs/architecture/testing-strategy.md`:

- Page tests: `apps/web/src/app/(dashboard)/clients/[id]/__tests__/`
- Component tests: `apps/web/src/components/clients/__tests__/`
- API tests: `apps/web/src/app/api/action-items/__tests__/`
- Test framework: Jest ^29.7.0 + @testing-library/react ^14.1.2

**Testing Standards:**

- Use Jest + Testing Library (already configured in project)
- Mock Next.js router (`useParams`, `useSearchParams`, `useRouter`)
- Mock API fetch for client data and action items
- Mock `useActionItems` custom hook for component tests
- Test optimistic updates and error rollback
- Test responsive layout (desktop vs mobile breakpoints)

**Required Test Files:**

1. `apps/web/src/app/(dashboard)/clients/[id]/__tests__/page.test.tsx` (8+ tests)
2. `apps/web/src/components/clients/__tests__/ClientActionItemsSidebar.test.tsx` (6+ tests)
3. `apps/web/src/components/clients/__tests__/ActionItemCard.test.tsx` (10+ tests)
4. `apps/web/src/components/clients/__tests__/ClientNextSteps.test.tsx` (6+ tests)
5. `apps/web/src/app/api/action-items/__tests__/route.test.ts` (8+ tests)

**Mocking Requirements:**

```typescript
// Mock Next.js router
jest.mock('next/navigation', () => ({
  useParams: () => ({ id: 'client-123' }),
  useSearchParams: () => new URLSearchParams({ tab: 'overview' }),
  useRouter: () => ({
    push: jest.fn(),
    back: jest.fn(),
  }),
}));

// Mock action items data
const mockActionItems: ActionItem[] = [
  {
    id: '1',
    client_id: 'client-123',
    description: 'Follow up on proposal',
    completed: false,
    due_date: '2026-01-15'
  },
  {
    id: '2',
    client_id: 'client-123',
    description: 'Send contract',
    completed: true,
    due_date: '2026-01-10'
  },
];

// Mock client data
const mockClient: Client = {
  id: 'client-123',
  name: 'Acme Corp',
  role: 'CEO',
  next_steps: ['Send pricing quote', 'Schedule demo call'],
};
```

**Specific Test Requirements:**

**Client Detail Page Tests:**
- Render client detail page with data
- 404 handling (client not found)
- Access control (RLS - user can't view other user's client)
- Tab switching (URL params)
- Back button navigation
- Edit/Delete dropdown menu
- Loading skeleton displays
- Error state with retry button

**Action Items Sidebar Tests:**
- Render action items list
- Empty state displayed when no items
- Count badge shows correct number (e.g., "Action Items (3)")
- "+ Add Action Item" button opens modal
- Scrollable when >5 items
- Accessibility (role, aria-label)

**ActionItemCard Tests:**
- Display action item description
- Checkbox toggle calls onToggle callback
- Completed items show strikethrough + gray text
- Due date badge displays correctly ("Jan 15")
- Overdue items show red badge
- Edit icon click calls onEdit
- Delete icon click calls onDelete
- Keyboard navigation (Tab, Enter, Space, Delete)
- Accessibility (aria-label, aria-checked)
- Optimistic update on checkbox toggle

**ClientNextSteps Tests:**
- Render next steps list
- Empty state displayed with placeholder text
- Add step button shows input field
- Edit step inline (click → input → save on Enter/blur)
- Delete step (click X icon)
- Update next steps API call (debounced 500ms)
- Max 10 steps validation
- Max 200 chars per step validation

**API Route Tests:**
- GET /api/action-items?client_id=123 returns filtered list
- POST /api/action-items creates action item
- PUT /api/action-items/[id] updates action item
- DELETE /api/action-items/[id] deletes action item
- PUT /api/clients/[id]/next-steps updates next steps
- RLS enforcement (401 for unauthorized access)
- Validation errors (400 for invalid data)
- 404 for not found

**Example Test Pattern:**

```typescript
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { ClientActionItemsSidebar } from '../ClientActionItemsSidebar';
import { ActionItem } from '@meetsolis/shared';

jest.mock('next/navigation', () => ({
  useRouter: () => ({ push: jest.fn() }),
}));

const mockActionItems: ActionItem[] = [
  { id: '1', client_id: 'client-123', description: 'Task 1', completed: false },
  { id: '2', client_id: 'client-123', description: 'Task 2', completed: true },
];

describe('ClientActionItemsSidebar', () => {
  test('displays action items count badge', () => {
    render(
      <ClientActionItemsSidebar
        clientId="client-123"
        actionItems={mockActionItems}
        onActionItemsChange={jest.fn()}
      />
    );

    expect(screen.getByText(/Action Items \(2\)/i)).toBeInTheDocument();
  });

  test('shows empty state when no action items', () => {
    render(
      <ClientActionItemsSidebar
        clientId="client-123"
        actionItems={[]}
        onActionItemsChange={jest.fn()}
      />
    );

    expect(screen.getByText('No action items yet')).toBeInTheDocument();
  });

  test('opens modal when "+ Add Action Item" clicked', () => {
    render(
      <ClientActionItemsSidebar
        clientId="client-123"
        actionItems={mockActionItems}
        onActionItemsChange={jest.fn()}
      />
    );

    fireEvent.click(screen.getByText('+ Add Action Item'));

    // Modal should open
    expect(screen.getByRole('dialog')).toBeInTheDocument();
  });
});

describe('ActionItemCard', () => {
  test('toggles checkbox and calls onToggle', async () => {
    const onToggle = jest.fn();
    const item: ActionItem = {
      id: '1',
      client_id: 'client-123',
      description: 'Follow up on proposal',
      completed: false,
    };

    render(
      <ActionItemCard
        actionItem={item}
        onToggle={onToggle}
        onEdit={jest.fn()}
        onDelete={jest.fn()}
      />
    );

    const checkbox = screen.getByRole('checkbox');
    fireEvent.click(checkbox);

    await waitFor(() => {
      expect(onToggle).toHaveBeenCalledWith(item.id);
    });
  });

  test('shows strikethrough for completed items', () => {
    const item: ActionItem = {
      id: '1',
      client_id: 'client-123',
      description: 'Completed task',
      completed: true,
    };

    render(
      <ActionItemCard
        actionItem={item}
        onToggle={jest.fn()}
        onEdit={jest.fn()}
        onDelete={jest.fn()}
      />
    );

    const description = screen.getByText('Completed task');
    expect(description).toHaveClass('line-through');
  });

  test('displays overdue badge in red', () => {
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);

    const item: ActionItem = {
      id: '1',
      client_id: 'client-123',
      description: 'Overdue task',
      completed: false,
      due_date: yesterday.toISOString(),
    };

    render(
      <ActionItemCard
        actionItem={item}
        onToggle={jest.fn()}
        onEdit={jest.fn()}
        onDelete={jest.fn()}
      />
    );

    const badge = screen.getByText(/Overdue/i);
    expect(badge).toHaveClass('bg-red-100'); // Or similar red styling
  });
});
```

**Responsive Layout Testing:**

```typescript
import { render } from '@testing-library/react';
import { ClientDetailLayout } from '../ClientDetailLayout';

describe('ClientDetailLayout', () => {
  test('renders 2-column layout on desktop', () => {
    // Mock window.matchMedia for desktop viewport
    global.matchMedia = jest.fn().mockImplementation(query => ({
      matches: query.includes('min-width: 1024px'),
      media: query,
      addEventListener: jest.fn(),
      removeEventListener: jest.fn(),
    }));

    const { container } = render(
      <ClientDetailLayout
        sidebar={<div>Sidebar</div>}
      >
        <div>Main Content</div>
      </ClientDetailLayout>
    );

    const grid = container.querySelector('.lg\\:grid-cols-3');
    expect(grid).toBeInTheDocument();
  });

  test('renders stacked layout on mobile', () => {
    // Mock window.matchMedia for mobile viewport
    global.matchMedia = jest.fn().mockImplementation(query => ({
      matches: query.includes('max-width: 1023px'),
      media: query,
      addEventListener: jest.fn(),
      removeEventListener: jest.fn(),
    }));

    const { container } = render(
      <ClientDetailLayout
        sidebar={<div>Sidebar</div>}
      >
        <div>Main Content</div>
      </ClientDetailLayout>
    );

    const grid = container.querySelector('.grid-cols-1');
    expect(grid).toBeInTheDocument();
  });
});
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-07 | 1.0 | Initial story creation | Sarah (PO) |
| 2026-01-12 | 2.0 | Complete rewrite to match Epic 2.6 spec - Added: 2-column layout, Action Items Sidebar, Next Steps section, action_items table, next_steps JSONB field, CRUD functionality, comprehensive testing specs. Updated: Tab names (Meeting History, Notes & Decisions), estimated effort (2 days), all tasks restructured | Sarah (PO) |

---

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

---

## QA Results

*This section will be populated by the QA agent after story completion.*
