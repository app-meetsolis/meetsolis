# Story 2.7: Manual Notes (Rich Text)

## Status

Draft

---

## Story

**As a** user,
**I want** to add manual notes to client cards,
**so that** I can capture information not from meetings.

---

## Acceptance Criteria

1. Notes field in clients table (TEXT, nullable)
2. Notes tab on client detail page
3. Rich text editor: Bold, italic, lists, links (using Tiptap or similar)
4. Auto-save every 5 seconds (debounced)
5. Save indicator: "Saving...", "Saved", "Error saving"
6. Character limit: 50,000 characters
7. Markdown export option
8. Notes searchable via client search (Story 2.4)

---

## Tasks / Subtasks

- [ ] **Task 1: Database Schema Update** (AC: 1)
  - [ ] Verify `notes` field exists in clients table (already in migration from Story 2.1)
  - [ ] Field: `notes TEXT` (nullable)
  - [ ] No migration needed (already included in v2.0 migration)

- [ ] **Task 2: Rich Text Editor Component** (AC: 2, 3, 6)
  - [ ] Install Tiptap: `npm install @tiptap/react @tiptap/starter-kit`
  - [ ] Create `apps/web/src/components/clients/NotesEditor.tsx`
  - [ ] Initialize Tiptap editor with extensions:
    - StarterKit (includes basic formatting)
    - Bold, Italic, Underline
    - BulletList, OrderedList
    - Heading (H1-H3)
    - Link
  - [ ] Add toolbar with formatting buttons
  - [ ] Implement character counter (50,000 limit)
  - [ ] Disable editor when limit reached

- [ ] **Task 3: Auto-Save Logic** (AC: 4, 5)
  - [ ] Implement debounced auto-save (5 seconds)
  - [ ] Use `useDebounce` hook for notes content
  - [ ] On change â†’ trigger debounced save
  - [ ] Call PUT /api/clients/[id] with notes field
  - [ ] Display save status indicator:
    - "Saving..." (during save)
    - "Saved" (on success, show for 2 seconds)
    - "Error saving" (on error, persist until retry)
  - [ ] Retry on error (automatic retry after 5 seconds)

- [ ] **Task 4: API Route for Notes Update** (AC: 4)
  - [ ] Update PUT /api/clients/[id] to accept notes field
  - [ ] Validate notes: max 50,000 characters
  - [ ] Update client.notes in database
  - [ ] Return updated client
  - [ ] Error handling: 400 (too long), 404 (not found), 500 (server error)

- [ ] **Task 5: Notes Tab Integration** (AC: 2)
  - [ ] Update `ClientTabs.tsx` (Story 2.6)
  - [ ] Add NotesEditor to "Notes" tab
  - [ ] Load client.notes on mount
  - [ ] Pass client.id and initial notes to NotesEditor

- [ ] **Task 6: Markdown Export** (AC: 7)
  - [ ] Add "Export as Markdown" button below editor
  - [ ] Convert Tiptap content to Markdown using `@tiptap/extension-markdown`
  - [ ] Trigger download: `notes-{client-name}-{date}.md`
  - [ ] Include client name and date in markdown header

- [ ] **Task 7: Search Integration** (AC: 8)
  - [ ] Update client search logic (Story 2.4)
  - [ ] Include `notes` field in search query
  - [ ] Search by: name, company, notes (case-insensitive)
  - [ ] Example: `client.notes?.toLowerCase().includes(query.toLowerCase())`

- [ ] **Task 8: Loading & Error States** (AC: 2)
  - [ ] Show skeleton while loading client notes
  - [ ] Display error message if notes fail to load
  - [ ] Add retry button for load errors

- [ ] **Task 9: Component Tests**
  - [ ] Test editor renders with initial notes
  - [ ] Test formatting (bold, italic, lists, headings, links)
  - [ ] Test auto-save (debounced 5 seconds)
  - [ ] Test save status indicator
  - [ ] Test character limit enforcement (50,000 chars)
  - [ ] Test markdown export
  - [ ] Test error handling (save failure)

---

## Dev Notes

### Relevant Architecture

**Rich Text Editor:**
- Library: Tiptap (https://tiptap.dev/)
- Extensions: StarterKit, Bold, Italic, Underline, BulletList, OrderedList, Heading, Link
- Output format: HTML (stored in database)
- Export format: Markdown (for user download)

**Tiptap Setup:**
```typescript
import { useEditor, EditorContent } from '@tiptap/react';
import StarterKit from '@tiptap/starter-kit';
import Link from '@tiptap/extension-link';

const editor = useEditor({
  extensions: [
    StarterKit,
    Link.configure({ openOnClick: false }),
  ],
  content: initialNotes,
  onUpdate: ({ editor }) => {
    const html = editor.getHTML();
    handleNotesChange(html);
  },
});
```

**Auto-Save:**
```typescript
// Debounce notes changes
const debouncedNotes = useDebounce(notes, 5000);

// Auto-save effect
useEffect(() => {
  if (debouncedNotes && debouncedNotes !== initialNotes) {
    saveNotes(debouncedNotes);
  }
}, [debouncedNotes]);
```

**Markdown Export:**
```typescript
import { generateMarkdown } from '@tiptap/extension-markdown';

function exportMarkdown() {
  const markdown = generateMarkdown(editor.getJSON());
  const blob = new Blob([markdown], { type: 'text/markdown' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `notes-${client.name}-${new Date().toISOString().split('T')[0]}.md`;
  a.click();
}
```

**Component Library:**
- Tiptap for rich text editor
- Shadcn Button for toolbar buttons
- Lucide icons: Bold, Italic, List, Link, Download

**Source Tree:**
- Editor component: `apps/web/src/components/clients/NotesEditor.tsx`
- Toolbar component: `apps/web/src/components/clients/NotesToolbar.tsx`
- Integration: `apps/web/src/app/clients/[id]/page.tsx` (Notes tab)

**API Integration:**
- PUT /api/clients/[id] with `{ notes: string }`
- Returns updated client
- Auto-save sends only notes field (not entire client object)

### Testing

**Test Location:**
- Component tests: `apps/web/src/components/clients/__tests__/`

**Testing Standards:**
- Use Jest + Testing Library
- Mock Tiptap editor for unit tests
- Test auto-save with fake timers

**Specific Requirements:**
- Test editor renders with initial notes
- Test formatting buttons work
- Test auto-save triggers after 5 seconds
- Test save status indicator updates
- Test character limit enforcement
- Test markdown export
- Test error handling

**Example Test Pattern:**
```typescript
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { act } from 'react-dom/test-utils';
import NotesEditor from '../NotesEditor';

jest.useFakeTimers();

test('auto-saves notes after 5 seconds', async () => {
  const onSave = jest.fn();
  render(<NotesEditor initialNotes="" onSave={onSave} />);

  // Type in editor
  const editor = screen.getByRole('textbox');
  fireEvent.input(editor, { target: { innerHTML: '<p>New note</p>' } });

  // Should show "Saving..." immediately
  expect(screen.getByText('Saving...')).toBeInTheDocument();

  // Fast-forward 5 seconds
  act(() => {
    jest.advanceTimersByTime(5000);
  });

  // Should call save
  await waitFor(() => {
    expect(onSave).toHaveBeenCalledWith('<p>New note</p>');
  });

  // Should show "Saved"
  expect(screen.getByText('Saved')).toBeInTheDocument();
});
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-07 | 1.0 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

---

## QA Results

*This section will be populated by the QA agent after story completion.*
