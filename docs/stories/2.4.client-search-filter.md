# Story 2.4: Client Search & Filter

## Status

Draft

---

## Story

**As a** user,
**I want** to search and filter my clients,
**so that** I can quickly find specific clients.

---

## Acceptance Criteria

1. Search bar above client grid
2. Search by: Client name, Company name (case-insensitive)
3. Debounced search (300ms delay)
4. Filter by tags (if tags exist)
5. Sort options: Name (A-Z), Last Meeting (recent first), Date Added (newest first)
6. Empty search result: "No clients found matching '[query]'"
7. Clear search button (X icon)
8. Search persists in URL query params (shareable)

---

## Tasks / Subtasks

- [ ] **Task 1: Search Bar Component** (AC: 1, 3, 7)
  - [ ] Create `apps/web/src/components/clients/ClientSearch.tsx`
  - [ ] Add search input field (Shadcn Input)
  - [ ] Add search icon (Lucide Search icon)
  - [ ] Add clear button (X icon) - visible only when query not empty
  - [ ] Implement debounced search (300ms delay using `useDebouncedValue` hook)
  - [ ] Update URL query params on search change
  - [ ] Read initial search query from URL params on mount

- [ ] **Task 2: Filter Component** (AC: 4, 5)
  - [ ] Add filter dropdown (Shadcn Select or DropdownMenu)
  - [ ] Filter by tags: Show list of all unique tags from user's clients
  - [ ] Allow multi-select for tags (Shadcn Multi-Select or custom)
  - [ ] Sort options dropdown:
    - "Name (A-Z)"
    - "Last Meeting (recent first)"
    - "Date Added (newest first)"
  - [ ] Update URL query params on filter/sort change
  - [ ] Read initial filter/sort from URL params

- [ ] **Task 3: Search Logic** (AC: 2, 3)
  - [ ] Implement client-side filtering function
  - [ ] Filter by name (case-insensitive): `client.name.toLowerCase().includes(query.toLowerCase())`
  - [ ] Filter by company (case-insensitive): `client.company?.toLowerCase().includes(query.toLowerCase())`
  - [ ] Combine name and company searches (OR condition)
  - [ ] Return filtered clients array

- [ ] **Task 4: Sort Logic** (AC: 5)
  - [ ] Implement sort function
  - [ ] Sort by name (A-Z): `clients.sort((a, b) => a.name.localeCompare(b.name))`
  - [ ] Sort by last meeting (recent first): `clients.sort((a, b) => new Date(b.last_meeting_at) - new Date(a.last_meeting_at))`
  - [ ] Sort by date added (newest first): `clients.sort((a, b) => new Date(b.created_at) - new Date(a.created_at))`
  - [ ] Handle null values for last_meeting_at (move to end)

- [ ] **Task 5: Empty Search State** (AC: 6)
  - [ ] Create `apps/web/src/components/clients/ClientSearchEmpty.tsx`
  - [ ] Display when filtered clients.length === 0 and query is not empty
  - [ ] Show message: "No clients found matching '[query]'"
  - [ ] Add "Clear search" button â†’ reset query

- [ ] **Task 6: URL Query Params Integration** (AC: 8)
  - [ ] Use Next.js `useSearchParams` and `useRouter` hooks
  - [ ] Update URL on search: `/clients?q=acme`
  - [ ] Update URL on filter: `/clients?tags=vip,active`
  - [ ] Update URL on sort: `/clients?sort=name-asc`
  - [ ] Parse query params on page load
  - [ ] Apply search/filter/sort from URL params
  - [ ] Support shareable URLs (copy/paste URL preserves search)

- [ ] **Task 7: Performance Optimization** (AC: 3)
  - [ ] Implement debouncing (300ms) using `use-debounce` library
  - [ ] Prevent excessive re-renders during typing
  - [ ] Memoize filtered/sorted clients array (useMemo)
  - [ ] Test performance with 50 clients

- [ ] **Task 8: Integration with Dashboard** (AC: 1)
  - [ ] Add ClientSearch component above ClientGrid in `/clients` page
  - [ ] Pass filtered/sorted clients to ClientGrid
  - [ ] Handle search empty state vs no clients empty state

- [ ] **Task 9: Component Tests**
  - [ ] Test search filtering by name
  - [ ] Test search filtering by company
  - [ ] Test debounced search (300ms delay)
  - [ ] Test clear search button
  - [ ] Test tag filtering
  - [ ] Test sorting (name, last meeting, date added)
  - [ ] Test empty search state
  - [ ] Test URL query params (read/write)

---

## Dev Notes

### Relevant Architecture

**Search/Filter Strategy:**
- Client-side filtering for <50 clients (as per Epic 2 PRD)
- Server-side search if >50 clients (future enhancement)
- All filtering/sorting happens in React component

**Debouncing:**
- Use `use-debounce` library: `const debouncedQuery = useDebounce(query, 300)`
- Prevents API calls on every keystroke
- 300ms delay balances responsiveness and performance

**URL Query Params:**
```typescript
// Read from URL
const searchParams = useSearchParams();
const query = searchParams.get('q') || '';
const tags = searchParams.get('tags')?.split(',') || [];
const sort = searchParams.get('sort') || 'date-added';

// Write to URL
const router = useRouter();
const params = new URLSearchParams(searchParams);
params.set('q', query);
router.push(`/clients?${params.toString()}`);
```

**Component Library:**
- Shadcn Input for search bar
- Shadcn Select for sort dropdown
- Shadcn Badge for tag filters
- Lucide icons: Search, X (clear)

**Source Tree:**
- Search component: `apps/web/src/components/clients/ClientSearch.tsx`
- Empty state: `apps/web/src/components/clients/ClientSearchEmpty.tsx`
- Integration: `apps/web/src/app/clients/page.tsx`

**Example Filtering Logic:**
```typescript
const filteredClients = clients.filter(client => {
  // Search filter
  const matchesSearch = query
    ? client.name.toLowerCase().includes(query.toLowerCase()) ||
      client.company?.toLowerCase().includes(query.toLowerCase())
    : true;

  // Tag filter
  const matchesTags = selectedTags.length > 0
    ? selectedTags.some(tag => client.tags.includes(tag))
    : true;

  return matchesSearch && matchesTags;
});

// Sort
const sortedClients = [...filteredClients].sort((a, b) => {
  if (sortBy === 'name-asc') return a.name.localeCompare(b.name);
  if (sortBy === 'last-meeting') {
    const dateA = a.last_meeting_at ? new Date(a.last_meeting_at) : new Date(0);
    const dateB = b.last_meeting_at ? new Date(b.last_meeting_at) : new Date(0);
    return dateB.getTime() - dateA.getTime();
  }
  if (sortBy === 'date-added') {
    return new Date(b.created_at).getTime() - new Date(a.created_at).getTime();
  }
  return 0;
});
```

### Testing

**Test Location:**
- Component tests: `apps/web/src/components/clients/__tests__/`

**Testing Standards:**
- Use Jest + Testing Library
- Mock useSearchParams and useRouter
- Mock useDebounce hook

**Specific Requirements:**
- Test search filtering (case-insensitive)
- Test debouncing (use jest.useFakeTimers)
- Test tag filtering
- Test sorting algorithms
- Test URL query params integration
- Test empty search state

**Example Test Pattern:**
```typescript
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { act } from 'react-dom/test-utils';
import ClientSearch from '../ClientSearch';

jest.useFakeTimers();

test('debounces search input', async () => {
  const onSearchChange = jest.fn();
  render(<ClientSearch onSearchChange={onSearchChange} />);

  fireEvent.change(screen.getByPlaceholderText('Search clients...'), {
    target: { value: 'acme' },
  });

  // Should not call immediately
  expect(onSearchChange).not.toHaveBeenCalled();

  // Fast-forward 300ms
  act(() => {
    jest.advanceTimersByTime(300);
  });

  // Should call after debounce
  await waitFor(() => {
    expect(onSearchChange).toHaveBeenCalledWith('acme');
  });
});
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-07 | 1.0 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

---

## QA Results

*This section will be populated by the QA agent after story completion.*
