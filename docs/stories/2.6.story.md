# Story 2.6: Basic Recording and Meeting Persistence

## Status
Draft

## Story

**As a** freelancer,
**I want** to record important client meetings and access them later,
**so that** I can review discussions and create follow-up materials.

## Dependencies

**Required:**
- **Story 2.1** (WebRTC Infrastructure) - Meeting and media streams
- **Story 2.5** (Security) - Permission checks and audit logging

## Acceptance Criteria

1. Cloud recording to Supabase Storage with encrypted files
2. Recording start/stop controls with participant notifications
3. Automatic recording transcription using OpenAI Whisper
4. Recording playback interface with timeline scrubber
5. Recording sharing via secure, expiring links
6. Meeting metadata storage (duration, participants, timestamp)
7. Recording deletion after 30 days (configurable retention)
8. Local recording fallback option for offline storage
9. Recording permission requests and participant consent
10. Integration with meeting history in dashboard

## Tasks / Subtasks

- [ ] **Recording Infrastructure** (AC: 1, 8)
  - [ ] Install MediaRecorder API polyfill if needed
  - [ ] Implement cloud recording using MediaRecorder
  - [ ] Set up Supabase Storage bucket for recordings
  - [ ] Implement local recording fallback (download blob)
  - [ ] Create recordings table (migration 010)
  - [ ] Generate unique recording IDs
  - [ ] Write recording service tests

- [ ] **Recording Controls** (AC: 2, 9)
  - [ ] Add record button to control bar (host only by default)
  - [ ] Create RecordingIndicator component (red dot animation)
  - [ ] Implement start/stop recording logic
  - [ ] Show recording consent dialog to all participants
  - [ ] Require all participants to consent before starting
  - [ ] Display "Recording in progress" indicator to all
  - [ ] Add recording timer display
  - [ ] Write control component tests

- [ ] **Cloud Recording Upload** (AC: 1)
  - [ ] Configure Supabase Storage for large files
  - [ ] Implement chunked upload for recordings
  - [ ] Show upload progress indicator
  - [ ] Handle upload failures with retry logic
  - [ ] Encrypt recordings at rest (AES-256)
  - [ ] Generate signed URLs for playback
  - [ ] Write upload tests

- [ ] **Recording Transcription** (AC: 3)
  - [ ] Integrate OpenAI Whisper API
  - [ ] Extract audio from recording
  - [ ] Send audio to Whisper for transcription
  - [ ] Store transcript in database
  - [ ] Display transcript in playback interface
  - [ ] Implement transcript search functionality
  - [ ] Write transcription tests

- [ ] **Playback Interface** (AC: 4)
  - [ ] Create RecordingPlayer component
  - [ ] Implement video playback with controls
  - [ ] Add timeline scrubber for seeking
  - [ ] Display playback speed controls (0.5x, 1x, 1.5x, 2x)
  - [ ] Show transcript alongside video
  - [ ] Implement transcript timestamps (click to seek)
  - [ ] Add fullscreen playback option
  - [ ] Write playback component tests

- [ ] **Recording Sharing** (AC: 5)
  - [ ] Generate shareable links with expiration
  - [ ] Create public playback page (no auth required)
  - [ ] Implement password protection for shared links
  - [ ] Add download option for shared recordings
  - [ ] Track view analytics for shared recordings
  - [ ] Create API endpoint `/api/recordings/[id]/share` (POST)
  - [ ] Write sharing tests

- [ ] **Meeting Metadata** (AC: 6)
  - [ ] Store recording duration
  - [ ] Store participant list snapshot
  - [ ] Store recording timestamp
  - [ ] Store meeting title and description
  - [ ] Link recording to original meeting
  - [ ] Display metadata in dashboard
  - [ ] Write metadata tests

- [ ] **Retention Policy** (AC: 7)
  - [ ] Implement automatic deletion after 30 days
  - [ ] Add configurable retention settings
  - [ ] Create background job for deletion
  - [ ] Send deletion warning emails (7 days before)
  - [ ] Allow manual deletion by host
  - [ ] Create API endpoint `/api/recordings/[id]` (DELETE)
  - [ ] Write retention policy tests

- [ ] **Dashboard Integration** (AC: 10)
  - [ ] Add "Recordings" tab to dashboard
  - [ ] Display recording list with thumbnails
  - [ ] Show recording metadata (date, duration, participants)
  - [ ] Add search and filter functionality
  - [ ] Implement recording preview on hover
  - [ ] Add download and share buttons
  - [ ] Write dashboard integration tests

- [ ] **Database Schema** (AC: 1, 6, 7)
  - [ ] Create migration 010_add_recordings.sql
  - [ ] Create recordings table
  - [ ] Add recording_consents table for participant consent
  - [ ] Add recording_shares table for shared links
  - [ ] Add indexes for queries
  - [ ] Write migration tests

- [ ] **API Endpoints** (AC: 1, 5, 7)
  - [ ] POST `/api/meetings/[id]/recording/start`
  - [ ] POST `/api/meetings/[id]/recording/stop`
  - [ ] POST `/api/recordings/upload`
  - [ ] GET `/api/recordings/[id]`
  - [ ] POST `/api/recordings/[id]/share`
  - [ ] DELETE `/api/recordings/[id]`
  - [ ] GET `/api/recordings` (list recordings)
  - [ ] Write API endpoint tests

## Dev Notes

### Dependencies Context

**Story 2.1 Provides:**
- MediaStream access
- Meeting infrastructure
- Supabase integration

**Story 2.5 Provides:**
- Permission checking patterns
- Audit logging
- Secure link generation

### Technology Stack

[Source: architecture/tech-stack.md]

**Required Dependencies:**
- `openai` ^4.24.1 - Whisper transcription
- MediaRecorder API (browser native)
- `@supabase/storage-js` ^2.5.1 - File storage

**Configuration:**
```env
OPENAI_API_KEY=<your_key>
OPENAI_ORGANIZATION=<your_org>
```

### Database Schema

**Migration 010:**
```sql
CREATE TABLE recordings (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    meeting_id UUID NOT NULL REFERENCES meetings(id),
    host_id UUID NOT NULL REFERENCES users(id),
    storage_path TEXT NOT NULL,
    duration INTEGER, -- seconds
    file_size BIGINT,
    transcript TEXT,
    status TEXT DEFAULT 'processing' CHECK (status IN ('processing', 'ready', 'failed', 'deleted')),
    participants JSONB,
    retention_days INTEGER DEFAULT 30,
    delete_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE recording_consents (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    recording_id UUID REFERENCES recordings(id),
    user_id UUID REFERENCES users(id),
    consented BOOLEAN NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE recording_shares (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    recording_id UUID REFERENCES recordings(id),
    share_token UUID UNIQUE DEFAULT uuid_generate_v4(),
    password_hash TEXT,
    expires_at TIMESTAMP WITH TIME ZONE,
    view_count INTEGER DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### MediaRecorder Implementation

```typescript
const startRecording = async (stream: MediaStream) => {
  const mimeType = MediaRecorder.isTypeSupported('video/webm; codecs=vp9')
    ? 'video/webm; codecs=vp9'
    : 'video/webm';

  const recorder = new MediaRecorder(stream, {
    mimeType,
    videoBitsPerSecond: 2500000 // 2.5 Mbps
  });

  const chunks: Blob[] = [];

  recorder.ondataavailable = (e) => {
    if (e.data.size > 0) {
      chunks.push(e.data);
    }
  };

  recorder.onstop = async () => {
    const blob = new Blob(chunks, { type: mimeType });
    await uploadRecording(blob);
  };

  recorder.start(1000); // Collect data every 1s
  return recorder;
};
```

### OpenAI Whisper Integration

```typescript
import { OpenAI } from 'openai';

async function transcribeRecording(audioFile: File) {
  const openai = new OpenAI({
    apiKey: process.env.OPENAI_API_KEY
  });

  const transcription = await openai.audio.transcriptions.create({
    file: audioFile,
    model: 'whisper-1',
    response_format: 'verbose_json',
    timestamp_granularities: ['segment']
  });

  return transcription;
}
```

### Testing Strategy

**Key Test Scenarios:**
1. Start recording with participant consent
2. Stop recording and upload to Supabase
3. Transcribe recording with Whisper
4. Play back recording with timeline
5. Share recording with expiring link
6. Delete recording after 30 days
7. Download recording locally
8. Search recordings in dashboard

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-13 | 1.0 | Initial story creation for recording and meeting persistence | Bob (Scrum Master) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

## QA Results

*Results from QA Agent review will be populated here after story completion*
